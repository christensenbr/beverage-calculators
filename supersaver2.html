<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperSaver - Beverage Negotiation Calculator</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            text-align: center;
            background: linear-gradient(135deg, #059669, #10a571);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .objectives {
            grid-column: span 2;
        }
        .week-planner {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .week-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .week-card {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            font-size: 12px;
        }
        .week-card.holiday {
            background: #fff3cd;
            border-color: #ffeaa7;
        }
        .week-card.coca-cola {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        .week-card.pepsi {
            background: #d1ecf1;
            border-color: #bee5eb;
        }
        .week-card.dps {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        .week-card.pl {
            background: #e2e3e5;
            border-color: #d6d8db;
        }
        select, input {
            padding: 5px;
            margin: 2px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .metric:last-child {
            border-bottom: none;
        }
        .metric-value {
            font-weight: bold;
            color: #2c3e50;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .summary-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
        }
        .summary-card h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .summary-value {
            font-size: 18px;
            font-weight: bold;
            color: #059669;
        }
        .promotion-details {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            font-size: 11px;
        }
        .cost-breakdown {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 5px;
            font-size: 11px;
        }
        .export-btn {
            background: #059669;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        .export-btn:hover {
            background: #10a571;
        }
        .brand-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .brand-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .brand-card h5 {
            margin: 0 0 5px 0;
            font-size: 12px;
        }
        .brand-value {
            font-size: 14px;
            font-weight: bold;
        }
        .week-status {
            font-size: 10px;
            color: #666;
            margin-top: 3px;
        }
        .week-status.success { color: #28a745; }
        .week-status.warning { color: #ffc107; }
        .week-status.danger { color: #dc3545; }
        .special-initiatives {
            margin-top: 10px;
            padding: 10px;
            background: #e7f3ff;
            border-radius: 5px;
            border: 1px solid #b3d9ff;
        }
        .initiative-title {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .group-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 5px 0;
        }
        .group-checkbox {
            display: flex;
            align-items: center;
            font-size: 11px;
            margin-right: 10px;
        }
        .group-checkbox input {
            margin-right: 3px;
        }
        .tier-section {
            margin: 8px 0;
            padding: 8px;
            background: #e8e8e8;
            border-radius: 3px;
        }
        .tier-title {
            font-weight: bold;
            font-size: 12px;
            color: #333;
            margin-bottom: 3px;
        }
        .tier-description {
            font-size: 10px;
            color: #666;
            margin-bottom: 5px;
        }
        .tier-separator {
            height: 2px;
            background: #ddd;
            margin: 15px 0;
        }
        .export-display {
            display: none;
            background: #f8f9fa;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .export-textarea {
            width: 100%;
            height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }
        .reset-section {
            text-align: center;
            margin-bottom: 20px;
        }
        .reset-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin: 0 5px;
        }
        .reset-btn:hover {
            background: #c82333;
        }
        .passcode-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .passcode-dialog {
            background: white;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
        }
        .passcode-dialog h2 {
            margin-top: 0;
            color: #228B22;
        }
        .passcode-dialog input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            margin: 20px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        .passcode-dialog button {
            background: #228B22;
            color: white;
            border: none;
            padding: 10px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
        }
        .passcode-dialog button:hover {
            background: #32CD32;
        }
        .passcode-error {
            color: #dc3545;
            margin-top: 10px;
        }
        .negotiation-selector-section {
            text-align: center;
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .negotiation-status {
            text-align: center;
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 13px;
        }
        .readonly-banner {
            text-align: center;
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-weight: bold;
            color: #856404;
        }
        .instructor-banner {
            text-align: center;
            background: #d4edda;
            border: 2px solid #28a745;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-weight: bold;
            color: #155724;
        }
        .checkpoint-controls {
            text-align: center;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .checkpoint-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }
        .checkpoint-btn:hover {
            background: #218838;
        }
        .checkpoint-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="passcode-overlay" class="passcode-overlay">
        <div class="passcode-dialog">
            <h2>üõí SuperSaver Calculator</h2>
            <p>Enter passcode to access:</p>
            <input type="password" id="passcode-input" placeholder="Enter passcode">
            <div id="passcode-error" class="passcode-error"></div>
            <button onclick="checkPasscode()">Access Calculator</button>
        </div>
    </div>

    <div id="main-content" style="display: none;">
        <div class="header">
            <h1>üõí SuperSaver - Beverage Negotiation Calculator</h1>
            <p>Plan your 26-week promotional calendar for the CSD category</p>
        </div>

        <div class="negotiation-selector-section">
            <label for="negotiation-select" style="font-weight: bold; margin-right: 10px;">Select Your Negotiation:</label>
            <select id="negotiation-select" onchange="changeNegotiation()" style="padding: 8px; font-size: 14px; border-radius: 5px;">
                <option value="">-- Select Negotiation --</option>
                <option value="negotiation-a">Negotiation A</option>
                <option value="negotiation-b">Negotiation B</option>
                <option value="negotiation-c">Negotiation C</option>
                <option value="negotiation-d">Negotiation D</option>
                <option value="negotiation-e">Negotiation E</option>
                <option value="negotiation-f">Negotiation F</option>
                <option value="negotiation-g">Negotiation G</option>
                <option value="negotiation-h">Negotiation H</option>
                <option value="negotiation-i">Negotiation I</option>
                <option value="negotiation-j">Negotiation J (Instructor Examples)</option>
            </select>
            <button id="instructor-unlock-btn" onclick="promptInstructorPasscode()" style="display: none; margin-left: 10px; padding: 8px 12px; background: #ffc107; border: none; border-radius: 5px; cursor: pointer;">üîì Instructor Mode</button>
        </div>
        
        <div id="negotiation-status" class="negotiation-status" style="display: none;">
            <strong>üìä Currently Viewing:</strong> <span id="current-negotiation"></span> - SuperSaver Calculator
            <span style="margin-left: 20px;" id="last-updated"></span>
            <span style="margin-left: 20px; color: #28a745;" id="sync-indicator">‚óè Auto-sync enabled</span>
        </div>

        <div id="readonly-banner" class="readonly-banner" style="display: none;">
            üìö Viewing instructor examples - Read-only mode. Changes will not be saved.
        </div>
        
        <div id="instructor-banner" class="instructor-banner" style="display: none;">
            üîì Instructor Mode - Changes will be saved
        </div>
        
        <div id="checkpoint-controls" class="checkpoint-controls" style="display: none;">
            <input type="text" id="checkpoint-name" placeholder="Checkpoint name (e.g., Draft 1)" style="padding: 8px; width: 200px; border: 1px solid #ddd; border-radius: 5px;">
            <button class="checkpoint-btn" onclick="saveCheckpoint()">üíæ Save Checkpoint</button>
            <select id="checkpoint-select" onchange="promptRestoreCheckpoint()" style="margin-left: 10px; padding: 8px;">
                <option value="">-- Restore from Checkpoint --</option>
            </select>
        </div>

        <div class="reset-section">
            <button class="reset-btn" onclick="resetAllData()">Reset Calculator</button>
            <span style="font-size: 12px; color: #666; margin-left: 10px;">Clear all saved data and start fresh</span>
        </div>

        <div class="dashboard">
            <div class="card">
                <h3>Budget & Cost Tracking</h3>
                <div class="metric">
                    <span>Total Retailer Promotional Cost</span>
                    <span class="metric-value" id="total-retailer-cost">$0</span>
                </div>
                <div class="metric">
                    <span>Average Weekly Cost</span>
                    <span class="metric-value" id="avg-weekly-cost">$0</span>
                </div>
                <hr style="margin: 15px 0;">
                <div class="metric">
                    <span>Special Initiative Budget</span>
                    <span class="metric-value">$1,400,000 - $2,700,000</span>
                </div>
                <div class="metric">
                    <span>- Digital Platform Launch</span>
                    <span class="metric-value" id="digital-budget">$0 / $900,000 min</span>
                </div>
                <div class="metric">
                    <span>- Loyalty Program</span>
                    <span class="metric-value" id="loyalty-budget">$0 / $500,000 min</span>
                </div>
            </div>

            <div class="card">
                <h3>Performance Tracking</h3>
                <div class="metric">
                    <span>Total Category Net Sales (Est.)</span>
                    <span class="metric-value" id="total-sales">$0</span>
                </div>
                <div class="metric">
                    <span>Sales Growth vs. Prior Year</span>
                    <span class="metric-value" id="sales-growth">0%</span>
                </div>
                <div class="metric">
                    <span>Est. Category Margin</span>
                    <span class="metric-value" id="category-margin">25.4%</span>
                </div>
                <div class="metric">
                    <span>Total Promotional Weeks</span>
                    <span class="metric-value" id="promo-weeks">0 / 26</span>
                </div>
            </div>

            <div class="card objectives">
                <h3>SuperSaver Objectives</h3>
                <div class="summary-grid">
                    <div class="summary-card">
                        <h4>Net Retail Sales Growth</h4>
                        <div class="summary-value" id="obj-growth">0%</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Target: +3% vs. Prior Year</div>
                    </div>
                    <div class="summary-card">
                        <h4>Category Profitability</h4>
                        <div class="summary-value" id="obj-profit">25.4%</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Target: Maintain Prior Year (25.4%)</div>
                    </div>
                    <div class="summary-card">
                        <h4>Trade Funding Secured</h4>
                        <div class="summary-value" id="obj-funding">$0</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Target: $20M+</div>
                        <div style="font-size: 10px; color: #999; margin-top: 5px;" id="funding-exact">Exact: $0</div>
                    </div>
                    <div class="summary-card">
                        <h4>vs ValueMart</h4>
                        <div class="summary-value" id="obj-competitive">TBD</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Defend/Gain Share</div>
                    </div>
                </div>
                
                <div class="brand-summary">
                    <div class="brand-card">
                        <h5>Coca-Cola</h5>
                        <div class="brand-value" id="cc-weeks">T1: 0 | T2: 0</div>
                        <div class="week-status success">Target: 10-15 T1</div>
                    </div>
                    <div class="brand-card">
                        <h5>PepsiCo</h5>
                        <div class="brand-value" id="pepsi-weeks">T1: 0 | T2: 0</div>
                        <div class="week-status success">Target: 10-15 T1</div>
                    </div>
                    <div class="brand-card">
                        <h5>DPS</h5>
                        <div class="brand-value" id="dps-weeks">T1: 0 | T2: 0</div>
                        <div class="week-status" id="dps-status">Target: 1-2 T1, 6 T2</div>
                    </div>
                    <div class="brand-card">
                        <h5>Private Label</h5>
                        <div class="brand-value" id="pl-weeks">T1: 0 | T2: 0</div>
                        <div class="week-status" id="pl-status">Target: 2-3 T1, 5-6 T2</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="week-planner">
            <h3>26-Week Promotional Calendar</h3>
            <p>Award display positions and set promotional requirements</p>
            
            <button class="export-btn" onclick="showCocaColaExport()">üìã Export for Coca-Cola</button>
            <button class="export-btn" onclick="showPepsiExport()">üìã Export for PepsiCo</button>

            <div id="exportDisplay" class="export-display">
                <h4 id="exportTitle">üìã Export Data</h4>
                <p id="exportDescription">Copy the data below and share with the manufacturer:</p>
                <textarea id="exportTextarea" class="export-textarea" readonly placeholder="Export data will appear here..."></textarea>
                <div style="margin-top: 10px;">
                    <button class="export-btn" onclick="selectAllExportData()">Select All</button>
                    <button class="export-btn" onclick="hideExportData()" style="background: #666;">Hide</button>
                </div>
            </div>

            <div class="week-grid" id="week-grid"></div>
        </div>
    </div>

    <script>
        const CORRECT_PASSCODE = 'SAVEMORE';
        const INSTRUCTOR_PASSCODE = 'INSTRUCTOR2025';
        let instructorMode = false;
        let currentNegotiationId = null;
        let isReadOnly = false;
        window.currentTimestamp = null;

        const firebaseConfig = {
            apiKey: "AIzaSyCkQR4KBiXI84O0Ev9DDtyhQfeZCbivDJg",
            authDomain: "bev-negotiation-calculators.firebaseapp.com",
            databaseURL: "https://bev-negotiation-calculators-default-rtdb.firebaseio.com",
            projectId: "bev-negotiation-calculators",
            storageBucket: "bev-negotiation-calculators.firebasestorage.app",
            messagingSenderId: "413961627132",
            appId: "1:413961627132:web:58fb6959a2bc3bd6f1be79"
        };

        function checkPasscode() {
            const input = document.getElementById('passcode-input').value;
            const errorDiv = document.getElementById('passcode-error');
            
            if (input === CORRECT_PASSCODE) {
                sessionStorage.setItem('supersaver_authenticated', 'true');
                document.getElementById('passcode-overlay').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                initializeCalculator();
            } else {
                errorDiv.textContent = 'Incorrect passcode. Please try again.';
                document.getElementById('passcode-input').value = '';
            }
        }

        function initializeCalculator() {
            firebase.initializeApp(firebaseConfig);
            generateWeekGrid();
            updateDashboard();
        }

        function promptInstructorPasscode() {
            const input = prompt('Enter instructor passcode:');
            if (input === INSTRUCTOR_PASSCODE) {
                instructorMode = true;
                sessionStorage.setItem('supersaver_instructor', 'true');
                updateNegotiationJMode();
            } else if (input !== null) {
                alert('Incorrect instructor passcode');
            }
        }

        function updateNegotiationJMode() {
            const instructorBanner = document.getElementById('instructor-banner');
            const readonlyBanner = document.getElementById('readonly-banner');
            const checkpointControls = document.getElementById('checkpoint-controls');
            
            if (currentNegotiationId === 'negotiation-j') {
                if (instructorMode) {
                    instructorBanner.style.display = 'block';
                    readonlyBanner.style.display = 'none';
                    isReadOnly = false;
                    checkpointControls.style.display = 'block';
                    loadCheckpoints();
                } else {
                    instructorBanner.style.display = 'none';
                    readonlyBanner.style.display = 'block';
                    isReadOnly = true;
                    checkpointControls.style.display = 'none';
                }
                disableSaveButtons(!instructorMode);
            } else {
                instructorBanner.style.display = 'none';
                readonlyBanner.style.display = 'none';
                isReadOnly = false;
                checkpointControls.style.display = 'block';
                disableSaveButtons(false);
            }
        }

        function disableSaveButtons(disable) {
            const saveButtons = document.querySelectorAll('button, input, select');
            saveButtons.forEach(btn => {
                if (btn.id !== 'negotiation-select' && btn.id !== 'checkpoint-select' && btn.id !== 'instructor-unlock-btn') {
                    btn.disabled = disable;
                }
            });
        }

        function saveCheckpoint() {
            if (isReadOnly) {
                alert('Cannot save in read-only mode');
                return;
            }
            
            const negotiationId = document.getElementById('negotiation-select').value;
            if (!negotiationId) {
                alert('Please select a negotiation first');
                return;
            }
            
            const checkpointName = document.getElementById('checkpoint-name').value.trim();
            if (!checkpointName) {
                alert('Please enter a checkpoint name');
                return;
            }
            
            const maxCheckpoints = negotiationId === 'negotiation-j' ? 10 : 5;
            
            firebase.database().ref(`semesters/active/${negotiationId}`).once('value')
                .then((snapshot) => {
                    const data = snapshot.val() || {};
                    const checkpoints = Object.keys(data).filter(key => key.startsWith('supersaver-checkpoint-'));
                    
                    const existingCheckpoint = checkpoints.find(cp => {
                        const name = cp.replace('supersaver-checkpoint-', '');
                        return name === checkpointName;
                    });
                    
                    if (existingCheckpoint) {
                        if (confirm(`A checkpoint named "${checkpointName}" already exists. Replace it?`)) {
                            return saveCheckpointData(negotiationId, checkpointName);
                        }
                    } else if (checkpoints.length >= maxCheckpoints) {
                        const checkpointList = checkpoints.map(cp => cp.replace('supersaver-checkpoint-', '')).join('\n');
                        const toReplace = prompt(`You have ${maxCheckpoints} checkpoints (maximum). Enter the name of the checkpoint to replace:\n\n${checkpointList}`);
                        
                        if (toReplace) {
                            const checkpointKey = `supersaver-checkpoint-${toReplace}`;
                            if (checkpoints.includes(checkpointKey)) {
                                return firebase.database().ref(`semesters/active/${negotiationId}/${checkpointKey}`).remove()
                                    .then(() => saveCheckpointData(negotiationId, checkpointName));
                            } else {
                                alert('Checkpoint name not found');
                            }
                        }
                    } else {
                        return saveCheckpointData(negotiationId, checkpointName);
                    }
                })
                .catch((error) => {
                    console.error('Error checking checkpoints:', error);
                    alert('Failed to save checkpoint: ' + error.message);
                });
        }

        function saveCheckpointData(negotiationId, checkpointName) {
            const dataToSave = {
                weeklyPlans: weeklyPlans,
                specialInitiativeSpend: specialInitiativeSpend,
                timestamp: new Date().toISOString(),
                checkpointName: checkpointName
            };
            
            return firebase.database().ref(`semesters/active/${negotiationId}/supersaver-checkpoint-${checkpointName}`).set(dataToSave)
                .then(() => {
                    alert('Checkpoint saved: ' + checkpointName);
                    document.getElementById('checkpoint-name').value = '';
                    loadCheckpoints();
                })
                .catch((error) => {
                    console.error('Save failed:', error);
                    alert('Failed to save checkpoint: ' + error.message);
                });
        }

        function loadCheckpoints() {
            const negotiationId = document.getElementById('negotiation-select').value;
            if (!negotiationId) return;
            
            firebase.database().ref(`semesters/active/${negotiationId}`).once('value')
                .then((snapshot) => {
                    const data = snapshot.val() || {};
                    const checkpoints = Object.keys(data)
                        .filter(key => key.startsWith('supersaver-checkpoint-'))
                        .map(key => {
                            const name = key.replace('supersaver-checkpoint-', '');
                            const checkpoint = data[key];
                            return {
                                name: name,
                                timestamp: checkpoint.timestamp,
                                displayName: checkpoint.checkpointName || name
                            };
                        })
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    const select = document.getElementById('checkpoint-select');
                    select.innerHTML = '<option value="">-- Restore from Checkpoint --</option>';
                    
                    checkpoints.forEach(cp => {
                        const date = new Date(cp.timestamp);
                        const option = document.createElement('option');
                        option.value = cp.name;
                        option.textContent = `${cp.displayName} (${date.toLocaleString()})`;
                        select.appendChild(option);
                    });
                });
        }

        function promptRestoreCheckpoint() {
            const select = document.getElementById('checkpoint-select');
            const checkpointName = select.value;
            
            if (!checkpointName) return;
            
            if (confirm(`Restore checkpoint "${checkpointName}"? This will replace your current work.`)) {
                restoreCheckpoint(checkpointName);
            }
            
            select.value = '';
        }

        function restoreCheckpoint(checkpointName) {
            const negotiationId = document.getElementById('negotiation-select').value;
            
            firebase.database().ref(`semesters/active/${negotiationId}/supersaver-checkpoint-${checkpointName}`).once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        weeklyPlans = data.weeklyPlans || {};
                        specialInitiativeSpend = data.specialInitiativeSpend || { digital: 0, loyalty: 0 };
                        generateWeekGrid();
                        updateDashboard();
                        
                        // ISSUE 2 FIX: Save to Firebase to sync all browsers
                        saveToFirebase();
                        
                        alert('Checkpoint restored: ' + checkpointName);
                    }
                })
                .catch((error) => {
                    console.error('Restore failed:', error);
                    alert('Failed to restore checkpoint: ' + error.message);
                });
        }

        function saveToFirebase() {
            if (isReadOnly) {
                return;
            }
            
            const negotiationId = document.getElementById('negotiation-select').value;
            if (!negotiationId) {
                return;
            }
            
            const dataToSave = {
                weeklyPlans: weeklyPlans,
                specialInitiativeSpend: specialInitiativeSpend,
                timestamp: new Date().toISOString()
            };
            
            window.currentTimestamp = dataToSave.timestamp;
            
            firebase.database().ref(`semesters/active/${negotiationId}/supersaver`).set(dataToSave)
                .then(() => {
                    updateLastSaved(dataToSave.timestamp);
                })
                .catch((error) => {
                    console.error('Save failed:', error);
                });
        }

        function loadFromFirebase(negotiationId) {
            if (!negotiationId) return;
            
            currentNegotiationId = negotiationId;
            
            firebase.database().ref(`semesters/active/${negotiationId}/supersaver`).once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        weeklyPlans = data.weeklyPlans || {};
                        specialInitiativeSpend = data.specialInitiativeSpend || { digital: 0, loyalty: 0 };
                        window.currentTimestamp = data.timestamp;
                        generateWeekGrid();
                        updateDashboard();
                        updateNegotiationStatus(negotiationId, data.timestamp);
                        
                        setupRealtimeListener(negotiationId);
                    } else {
                        weeklyPlans = {};
                        specialInitiativeSpend = { digital: 0, loyalty: 0 };
                        window.currentTimestamp = null;
                        generateWeekGrid();
                        updateDashboard();
                        updateNegotiationStatus(negotiationId, null);
                        setupRealtimeListener(negotiationId);
                    }
                    
                    if (negotiationId === 'negotiation-j') {
                        document.getElementById('instructor-unlock-btn').style.display = 'inline-block';
                        if (sessionStorage.getItem('supersaver_instructor') === 'true') {
                            instructorMode = true;
                        }
                    } else {
                        document.getElementById('instructor-unlock-btn').style.display = 'none';
                        instructorMode = false;
                    }
                    
                    updateNegotiationJMode();
                    loadCheckpoints();
                })
                .catch((error) => {
                    console.error('Load failed:', error);
                    alert('Failed to load: ' + error.message);
                });
        }

        function setupRealtimeListener(negotiationId) {
            if (window.currentListener) {
                window.currentListener.off();
            }
            
            // Listen to main data
            window.currentListener = firebase.database().ref(`semesters/active/${negotiationId}/supersaver`);
            window.currentListener.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.timestamp !== window.currentTimestamp) {
                    weeklyPlans = data.weeklyPlans || {};
                    specialInitiativeSpend = data.specialInitiativeSpend || { digital: 0, loyalty: 0 };
                    window.currentTimestamp = data.timestamp;
                    generateWeekGrid();
                    updateDashboard();
                    updateLastSaved(data.timestamp);
                    
                    // ISSUE 3 FIX: Re-apply read-only mode after sync
                    updateNegotiationJMode();
                }
            });
            
            // ISSUE 1 FIX: Listen for checkpoint changes
            if (window.checkpointListener) {
                window.checkpointListener.off();
            }
            
            window.checkpointListener = firebase.database().ref(`semesters/active/${negotiationId}`);
            window.checkpointListener.on('child_added', (snapshot) => {
                if (snapshot.key.startsWith('supersaver-checkpoint-')) {
                    loadCheckpoints();
                }
            });
            window.checkpointListener.on('child_removed', (snapshot) => {
                if (snapshot.key.startsWith('supersaver-checkpoint-')) {
                    loadCheckpoints();
                }
            });
            window.checkpointListener.on('child_changed', (snapshot) => {
                if (snapshot.key.startsWith('supersaver-checkpoint-')) {
                    loadCheckpoints();
                }
            });
        }

        function changeNegotiation() {
            const negotiationId = document.getElementById('negotiation-select').value;
            if (negotiationId) {
                loadFromFirebase(negotiationId);
            } else {
                if (window.currentListener) {
                    window.currentListener.off();
                }
                // Clean up checkpoint listener too
                if (window.checkpointListener) {
                    window.checkpointListener.off();
                }
                weeklyPlans = {};
                specialInitiativeSpend = { digital: 0, loyalty: 0 };
                window.currentTimestamp = null;
                generateWeekGrid();
                updateDashboard();
                document.getElementById('negotiation-status').style.display = 'none';
                document.getElementById('checkpoint-controls').style.display = 'none';
                document.getElementById('instructor-unlock-btn').style.display = 'none';
                currentNegotiationId = null;
            }
        }

        function updateNegotiationStatus(negotiationId, timestamp) {
            const statusDiv = document.getElementById('negotiation-status');
            const currentNegDiv = document.getElementById('current-negotiation');
            
            if (negotiationId) {
                statusDiv.style.display = 'block';
                let displayName = negotiationId.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                if (negotiationId === 'negotiation-j') {
                    displayName += ' (Instructor Examples)';
                }
                currentNegDiv.textContent = displayName;
                updateLastSaved(timestamp);
            } else {
                statusDiv.style.display = 'none';
            }
        }

        function updateLastSaved(timestamp) {
            const lastUpdatedDiv = document.getElementById('last-updated');
            if (timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                
                let timeText;
                if (diffMins < 1) {
                    timeText = 'Just now';
                } else if (diffMins === 1) {
                    timeText = '1 minute ago';
                } else if (diffMins < 60) {
                    timeText = `${diffMins} minutes ago`;
                } else {
                    timeText = date.toLocaleString();
                }
                
                lastUpdatedDiv.textContent = `Last updated: ${timeText} ‚úì`;
            } else {
                lastUpdatedDiv.textContent = 'No saved data yet';
            }
        }

        function resetAllData() {
            if (isReadOnly) {
                alert('Cannot reset in read-only mode');
                return;
            }
            
            const negotiationId = document.getElementById('negotiation-select').value;
            if (!negotiationId) {
                alert('Please select a negotiation first');
                return;
            }
            
            if (confirm('Are you sure you want to reset all data for the current scenario in this negotiation? This will clear your current work and cannot be undone. This will NOT clear your saved promotional checkpoints, so if you want to come back to this scenario later, you should save it as a checkpoint first.')) {
                // Write empty data object instead of removing to trigger sync
                const emptyData = {
                    weeklyPlans: {},
                    specialInitiativeSpend: { digital: 0, loyalty: 0 },
                    timestamp: new Date().toISOString()
                };
                
                firebase.database().ref(`semesters/active/${negotiationId}/supersaver`).set(emptyData)
                    .then(() => {
                        weeklyPlans = {};
                        specialInitiativeSpend = { digital: 0, loyalty: 0 };
                        window.currentTimestamp = emptyData.timestamp;
                        generateWeekGrid();
                        updateDashboard();
                        alert('Data reset successfully');
                    })
                    .catch((error) => {
                        alert('Failed to reset: ' + error.message);
                    });
            }
        }

        const supersaverData = {
            baselines: {
                'coca-cola': { retail: 1477780, wholesale: 1071000, margin: 0.25 },
                'pepsi': { retail: 1275750, wholesale: 945000, margin: 0.22 },
                'dps': { retail: 553000, wholesale: 413000, margin: 0.27 },
                'pl': { retail: 466000, wholesale: 0, margin: 0.38 }
            },
            productGroups: {
                'coca-cola': {
                    'Group 1 - Coca-Cola': { wholesale: 346500, retail: 477970 },
                    'Group 2 - Diet Coke': { wholesale: 220500, retail: 304290 },
                    'Group 3 - Coke Zero Sugar': { wholesale: 157500, retail: 217350 },
                    'Group 4 - Sprite': { wholesale: 231000, retail: 318780 },
                    'Group 5 - Other Brands': { wholesale: 115500, retail: 159390 }
                },
                'pepsi': {
                    'Group 1 - Pepsi': { wholesale: 283500, retail: 382725 },
                    'Group 2 - Diet Pepsi': { wholesale: 178500, retail: 240975 },
                    'Group 3 - Pepsi Zero Sugar': { wholesale: 115500, retail: 155925 },
                    'Group 4 - Mountain Dew': { wholesale: 262500, retail: 354375 },
                    'Group 5 - Other Brands': { wholesale: 105000, retail: 141750 }
                },
                'dps': {
                    'DPS Brands': { wholesale: 413000, retail: 553000 }
                },
                'pl': {
                    'Private Label': { wholesale: 0, retail: 466000 }
                }
            },
            holidayMultipliers: {
                'Week 1': 1.4, 'Week 8': 1.1, 'Week 10': 1.2,
                'Week 18': 1.3, 'Week 22': 1.6, 'Week 26': 1.5
            },
            promotionalLifts: {
                tier1a: { bogo: 5.5, b2g1: 4.0, '25off': 3.2 },
                tier1b: { bogo: 4.8, b2g1: 3.5, '25off': 2.8 },
                tier2: { high: 2.8, low: 2.3 },
                tier3: { high: 1.4, low: 1.2 }
            },
            displayMultipliers: {
                'lobby': 1.3,
                'aisle': 1.15,
                'endcap': 1.0
            },
            costSharing: {
                bogo: { retailer: 0.15, manufacturer: 0.35 },
                b2g1: { retailer: 0.05, manufacturer: 0.2833 },
                '25off': { retailer: 0, manufacturer: 0.25 }
            },
            specialInitiatives: {
                digital: { min: 900000, max: 1700000 },
                loyalty: { min: 500000, max: 1000000 }
            }
        };

        let weeklyPlans = {};
        let specialInitiativeSpend = { digital: 0, loyalty: 0 };

        // Export functions
        function showCocaColaExport() {
            const competitorNetSales = calculateCompetitorNetSales('coca-cola');
            const ccPromotions = extractManufacturerPromotions('coca-cola');
            
            const exportData = {
                retailer: 'SuperSaver',
                manufacturer: 'Coca-Cola',
                timestamp: new Date().toISOString(),
                competitorNetSales: competitorNetSales,
                promotions: ccPromotions,
                summary: {
                    totalTier1Weeks: countWeeksByTier(ccPromotions, ['tier1a', 'tier1b']),
                    totalTier2Weeks: countWeeksByTier(ccPromotions, ['tier2']),
                    promotionTypes: {
                        bogo: countWeeksByPromoType(ccPromotions, 'bogo'),
                        b2g1: countWeeksByPromoType(ccPromotions, 'b2g1'),
                        '25off': countWeeksByPromoType(ccPromotions, '25off')
                    }
                }
            };
            
            document.getElementById('exportTitle').textContent = 'üìã Export Data for Coca-Cola';
            document.getElementById('exportDescription').textContent = 'Copy the data below and provide to the Coca-Cola negotiation team:';
            document.getElementById('exportTextarea').value = JSON.stringify(exportData, null, 2);
            document.getElementById('exportDisplay').style.display = 'block';
            saveToFirebase();
        }

        function showPepsiExport() {
            const competitorNetSales = calculateCompetitorNetSales('pepsi');
            const pepsiPromotions = extractManufacturerPromotions('pepsi');
            
            const exportData = {
                retailer: 'SuperSaver',
                manufacturer: 'PepsiCo',
                timestamp: new Date().toISOString(),
                competitorNetSales: competitorNetSales,
                promotions: pepsiPromotions,
                summary: {
                    totalTier1Weeks: countWeeksByTier(pepsiPromotions, ['tier1a', 'tier1b']),
                    totalTier2Weeks: countWeeksByTier(pepsiPromotions, ['tier2']),
                    promotionTypes: {
                        bogo: countWeeksByPromoType(pepsiPromotions, 'bogo'),
                        b2g1: countWeeksByPromoType(pepsiPromotions, 'b2g1'),
                        '25off': countWeeksByPromoType(pepsiPromotions, '25off')
                    }
                }
            };
            
            document.getElementById('exportTitle').textContent = 'üìã Export Data for PepsiCo';
            document.getElementById('exportDescription').textContent = 'Copy the data below and provide to the PepsiCo negotiation team:';
            document.getElementById('exportTextarea').value = JSON.stringify(exportData, null, 2);
            document.getElementById('exportDisplay').style.display = 'block';
            saveToFirebase();
        }

        function countWeeksByTier(promotions, tiers) {
            const weeks = new Set();
            promotions.forEach(promo => {
                if (tiers.includes(promo.tier)) {
                    weeks.add(promo.week);
                }
            });
            return weeks.size;
        }

        function countWeeksByPromoType(promotions, promoType) {
            const weeks = new Set();
            promotions.forEach(promo => {
                if (promo.promotionType === promoType) {
                    weeks.add(promo.week);
                }
            });
            return weeks.size;
        }

        function calculateCompetitorNetSales(manufacturerBrand) {
            let competitorSales = 0;
            
            for (let week = 1; week <= 26; week++) {
                const weekKey = `Week ${week}`;
                const plan = weeklyPlans[weekKey] || {};
                const holidayMult = supersaverData.holidayMultipliers[weekKey] || 1.0;
                
                Object.keys(supersaverData.baselines).forEach(brand => {
                    if (brand === manufacturerBrand) return;
                    
                    const baseline = supersaverData.baselines[brand];
                    const productGroups = supersaverData.productGroups[brand];
                    
                    if (brand === 'pl' || brand === 'dps') {
                        let brandNetSales = 0;
                        let hasSpecialInitiative = false;
                        
                        const groupKey = brand === 'dps' ? 'DPS Brands' : 'Private Label';
                        const brandGroupKey = `${brand}-${groupKey}`;
                        
                        if (plan.loyalty_funding && (plan.loyalty_funding[groupKey] || plan.loyalty_funding[brandGroupKey])) {
                            hasSpecialInitiative = true;
                        }
                        if (!hasSpecialInitiative && plan.digital_funding && (plan.digital_funding[groupKey] || plan.digital_funding[brandGroupKey])) {
                            hasSpecialInitiative = true;
                        }
                        
                        if (brand === plan.winner && plan.promo_type) {
                            const displayMult = supersaverData.displayMultipliers[plan.display_type] || 1.0;
                            const lift = supersaverData.promotionalLifts.tier1a[plan.promo_type];
                            const grossSales = baseline.retail * lift * displayMult * holidayMult;
                            
                            if (plan.promo_type === 'bogo') {
                                brandNetSales = grossSales * 0.50;
                            } else if (plan.promo_type === 'b2g1') {
                                brandNetSales = grossSales * 0.6667;
                            } else if (plan.promo_type === '25off') {
                                brandNetSales = grossSales * 0.75;
                            }
                        } else if (brand === plan.tier2_allowed && plan.tier2_response) {
                            const baseLift = supersaverData.promotionalLifts.tier2[plan.tier2_response];
                            const tier2Discount = plan.tier2_response === 'high' ? 0.20 : 0.15;
                            
                            if (hasSpecialInitiative) {
                                const baseGrossVolume = baseline.retail * baseLift * holidayMult;
                                const incrementalGrossVolume = baseline.retail * (baseLift * 1.3 - baseLift) * holidayMult;
                                const baseNetSales = baseGrossVolume * (1 - tier2Discount);
                                const incrementalNetSales = incrementalGrossVolume * (1 - 0.20);
                                brandNetSales = baseNetSales + incrementalNetSales;
                            } else {
                                const grossSales = baseline.retail * baseLift * holidayMult;
                                brandNetSales = grossSales * (1 - tier2Discount);
                            }
                        } else if (plan.tier3_investments && (plan.tier3_investments[groupKey] || plan.tier3_investments[brandGroupKey])) {
                            const investment = plan.tier3_investments[groupKey] || plan.tier3_investments[brandGroupKey];
                            const baseLift = supersaverData.promotionalLifts.tier3[investment];
                            const tier3Discount = investment === 'high' ? 0.10 : 0.05;
                            
                            if (hasSpecialInitiative) {
                                const baseGrossVolume = baseline.retail * baseLift * holidayMult;
                                const incrementalGrossVolume = baseline.retail * (baseLift * 1.9 - baseLift) * holidayMult;
                                const baseNetSales = baseGrossVolume * (1 - tier3Discount);
                                const incrementalNetSales = incrementalGrossVolume * (1 - 0.20);
                                brandNetSales = baseNetSales + incrementalNetSales;
                            } else {
                                const grossSales = baseline.retail * baseLift * holidayMult;
                                brandNetSales = grossSales * (1 - tier3Discount);
                            }
                        } else if (hasSpecialInitiative) {
                            const lift = 2.5;
                            const grossSales = baseline.retail * lift * holidayMult;
                            brandNetSales = grossSales * 0.80;
                        } else {
                            brandNetSales = baseline.retail * holidayMult;
                        }
                        
                        competitorSales += brandNetSales;
                        
                    } else if (brand === 'coca-cola' || brand === 'pepsi') {
                        Object.keys(productGroups).forEach(group => {
                            const groupData = productGroups[group];
                            let groupNetSales = 0;
                            let hasSpecialInitiative = false;
                            
                            const brandSpecificKey = `${brand}-${group}`;
                            if (plan.loyalty_funding && (plan.loyalty_funding[group] || plan.loyalty_funding[brandSpecificKey])) {
                                hasSpecialInitiative = true;
                            }
                            if (!hasSpecialInitiative && plan.digital_funding && (plan.digital_funding[group] || plan.digital_funding[brandSpecificKey])) {
                                hasSpecialInitiative = true;
                            }
                            
                            if (brand === plan.winner && plan.promo_type && plan.tier1a?.includes(group)) {
                                const displayMult = supersaverData.displayMultipliers[plan.display_type] || 1.0;
                                const lift = supersaverData.promotionalLifts.tier1a[plan.promo_type];
                                const grossSales = groupData.retail * lift * displayMult * holidayMult;
                                
                                if (plan.promo_type === 'bogo') {
                                    groupNetSales = grossSales * 0.50;
                                } else if (plan.promo_type === 'b2g1') {
                                    groupNetSales = grossSales * 0.6667;
                                } else if (plan.promo_type === '25off') {
                                    groupNetSales = grossSales * 0.75;
                                }
                            } else if (brand === plan.winner && plan.promo_type && plan.tier1b?.includes(group)) {
                                const displayMult = supersaverData.displayMultipliers[plan.display_type] || 1.0;
                                const lift = supersaverData.promotionalLifts.tier1b[plan.promo_type];
                                const grossSales = groupData.retail * lift * displayMult * holidayMult;
                                
                                if (plan.promo_type === 'bogo') {
                                    groupNetSales = grossSales * 0.50;
                                } else if (plan.promo_type === 'b2g1') {
                                    groupNetSales = grossSales * 0.6667;
                                } else if (plan.promo_type === '25off') {
                                    groupNetSales = grossSales * 0.75;
                                }
                            } else if (brand === plan.tier2_allowed && plan.tier2_groups?.includes(group)) {
                                const baseLift = supersaverData.promotionalLifts.tier2[plan.tier2_response];
                                const tier2Discount = plan.tier2_response === 'high' ? 0.20 : 0.15;
                                
                                if (hasSpecialInitiative) {
                                    const baseGrossVolume = groupData.retail * baseLift * holidayMult;
                                    const incrementalGrossVolume = groupData.retail * (baseLift * 1.3 - baseLift) * holidayMult;
                                    const baseNetSales = baseGrossVolume * (1 - tier2Discount);
                                    const incrementalNetSales = incrementalGrossVolume * (1 - 0.20);
                                    groupNetSales = baseNetSales + incrementalNetSales;
                                } else {
                                    const grossSales = groupData.retail * baseLift * holidayMult;
                                    groupNetSales = grossSales * (1 - tier2Discount);
                                }
                            } else if (plan.tier3_investments && plan.tier3_investments[brand + '-' + group]) {
                                const investment = plan.tier3_investments[brand + '-' + group];
                                const baseLift = supersaverData.promotionalLifts.tier3[investment];
                                const tier3Discount = investment === 'high' ? 0.10 : 0.05;
                                
                                if (hasSpecialInitiative) {
                                    const baseGrossVolume = groupData.retail * baseLift * holidayMult;
                                    const incrementalGrossVolume = groupData.retail * (baseLift * 1.9 - baseLift) * holidayMult;
                                    const baseNetSales = baseGrossVolume * (1 - tier3Discount);
                                    const incrementalNetSales = incrementalGrossVolume * (1 - 0.20);
                                    groupNetSales = baseNetSales + incrementalNetSales;
                                } else {
                                    const grossSales = groupData.retail * baseLift * holidayMult;
                                    groupNetSales = grossSales * (1 - tier3Discount);
                                }
                            } else if (hasSpecialInitiative) {
                                const lift = 2.5;
                                const grossSales = groupData.retail * lift * holidayMult;
                                groupNetSales = grossSales * 0.80;
                            } else {
                                groupNetSales = groupData.retail * holidayMult;
                            }
                            
                            competitorSales += groupNetSales;
                        });
                    }
                });
            }
            
            return Math.round(competitorSales);
        }

        function extractManufacturerPromotions(manufacturerBrand) {
            const promotions = [];
            
            for (let week = 1; week <= 26; week++) {
                const weekKey = `Week ${week}`;
                const plan = weeklyPlans[weekKey] || {};
                
                if (plan.winner === manufacturerBrand && plan.promo_type) {
                    if (plan.tier1a && plan.tier1a.length > 0) {
                        plan.tier1a.forEach(group => {
                            promotions.push({
                                week: weekKey,
                                tier: 'tier1a',
                                productGroup: group,
                                promotionType: plan.promo_type,
                                displayType: plan.display_type
                            });
                        });
                    }
                    
                    if (plan.tier1b && plan.tier1b.length > 0) {
                        plan.tier1b.forEach(group => {
                            promotions.push({
                                week: weekKey,
                                tier: 'tier1b',
                                productGroup: group,
                                promotionType: plan.promo_type,
                                displayType: plan.display_type
                            });
                        });
                    }
                }
                
                if (plan.tier2_allowed === manufacturerBrand && plan.tier2_response) {
                    if (plan.tier2_groups && plan.tier2_groups.length > 0) {
                        plan.tier2_groups.forEach(group => {
                            promotions.push({
                                week: weekKey,
                                tier: 'tier2',
                                productGroup: group,
                                investmentLevel: plan.tier2_response
                            });
                        });
                    }
                }
                
                if (plan.tier3_investments) {
                    Object.keys(plan.tier3_investments).forEach(investmentKey => {
                        if (investmentKey.startsWith(manufacturerBrand + '-')) {
                            const group = investmentKey.substring(manufacturerBrand.length + 1);
                            promotions.push({
                                week: weekKey,
                                tier: 'tier3',
                                productGroup: group,
                                investmentLevel: plan.tier3_investments[investmentKey]
                            });
                        }
                    });
                }
                
                if (plan.loyalty_funding) {
                    Object.keys(plan.loyalty_funding).forEach(groupKey => {
                        let brand = null;
                        let group = groupKey;
                        
                        if (groupKey.startsWith(manufacturerBrand + '-')) {
                            brand = manufacturerBrand;
                            group = groupKey.substring(manufacturerBrand.length + 1);
                        } else if (supersaverData.productGroups[manufacturerBrand] && supersaverData.productGroups[manufacturerBrand][groupKey]) {
                            brand = manufacturerBrand;
                            group = groupKey;
                        }
                        
                        if (brand === manufacturerBrand) {
                            promotions.push({
                                week: weekKey,
                                tier: 'special_initiative',
                                type: 'loyalty',
                                productGroup: group,
                                fundingType: plan.loyalty_funding[groupKey]
                            });
                        }
                    });
                }
                
                if (plan.digital_funding) {
                    Object.keys(plan.digital_funding).forEach(groupKey => {
                        let brand = null;
                        let group = groupKey;
                        
                        if (groupKey.startsWith(manufacturerBrand + '-')) {
                            brand = manufacturerBrand;
                            group = groupKey.substring(manufacturerBrand.length + 1);
                        } else if (supersaverData.productGroups[manufacturerBrand] && supersaverData.productGroups[manufacturerBrand][groupKey]) {
                            brand = manufacturerBrand;
                            group = groupKey;
                        }
                        
                        if (brand === manufacturerBrand) {
                            promotions.push({
                                week: weekKey,
                                tier: 'special_initiative',
                                type: 'digital',
                                productGroup: group,
                                fundingType: plan.digital_funding[groupKey]
                            });
                        }
                    });
                }
            }
            
            return promotions;
        }

        function hideExportData() {
            document.getElementById('exportDisplay').style.display = 'none';
        }

        function selectAllExportData() {
            const textarea = document.getElementById('exportTextarea');
            textarea.select();
            textarea.setSelectionRange(0, 99999);
        }

        function generateWeekGrid() {
            const weekGrid = document.getElementById('week-grid');
            weekGrid.innerHTML = '';
            
            const weeks = [
                'Week 1 (July 4th)', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 
                'Week 6', 'Week 7', 'Week 8 (Back-to-School)', 'Week 9', 
                'Week 10 (Labor Day)', 'Week 11', 'Week 12', 'Week 13', 'Week 14', 
                'Week 15', 'Week 16', 'Week 17', 'Week 18 (Halloween)', 'Week 19', 
                'Week 20', 'Week 21', 'Week 22 (Thanksgiving)', 'Week 23', 'Week 24', 
                'Week 25', 'Week 26 (Christmas)'
            ];

            weeks.forEach((week, index) => {
                const weekKey = `Week ${index + 1}`;
                const isHoliday = supersaverData.holidayMultipliers[weekKey] > 1.0;
                const plan = weeklyPlans[weekKey] || {};
                
                const weekCard = document.createElement('div');
                let cardClass = 'week-card';
                if (isHoliday) cardClass += ' holiday';
                if (plan.winner) cardClass += ` ${plan.winner}`;
                weekCard.className = cardClass;
                
                weekCard.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">${week}</div>
                    <div style="font-size: 10px; color: #666;">
                        Holiday Mult: ${supersaverData.holidayMultipliers[weekKey] || 1.0}x
                    </div>
                    <select onchange="updateWeekWinner('${weekKey}', this.value)" style="width: 100%; margin: 5px 0;">
                        <option value="">No Display Winner</option>
                        <option value="coca-cola" ${plan.winner === 'coca-cola' ? 'selected' : ''}>Coca-Cola</option>
                        <option value="pepsi" ${plan.winner === 'pepsi' ? 'selected' : ''}>PepsiCo</option>
                        ${!isHoliday ? '<option value="dps" ' + (plan.winner === 'dps' ? 'selected' : '') + '>Dr Pepper Snapple</option>' : ''}
                        <option value="pl" ${plan.winner === 'pl' ? 'selected' : ''}>Private Label</option>
                    </select>
                    ${isHoliday && plan.winner !== 'dps' ? '<div style="font-size: 10px; color: #666;">DPS cannot have Tier 1 during holiday weeks</div>' : ''}
                    <div id="week-${weekKey.replace(/[\s()]/g, '_')}-details" style="margin-top: 5px;">
                        ${generateWeekDetails(weekKey, plan)}
                    </div>
                `;
                weekGrid.appendChild(weekCard);
            });
        }

        function generateWeekDetails(weekKey, plan) {
            if (!plan.winner) return '';

            let detailsHTML = `
                <div class="promotion-details">
                    <strong>Display Type:</strong>
                    <select onchange="updatePromoDetail('${weekKey}', 'display_type', this.value)" style="width: 100%;">
                        <option value="endcap" ${plan.display_type === 'endcap' ? 'selected' : ''}>End Cap Only</option>
                        <option value="aisle" ${plan.display_type === 'aisle' ? 'selected' : ''}>End Cap + Aisle</option>
                        <option value="lobby" ${plan.display_type === 'lobby' ? 'selected' : ''}>End Cap + Lobby</option>
                    </select>
                    
                    <strong style="margin-top: 5px; display: block;">Promotion Type Required:</strong>
                    <select onchange="updatePromoDetail('${weekKey}', 'promo_type', this.value)" style="width: 100%;">
                        <option value="">Select Promo</option>
                        <option value="bogo" ${plan.promo_type === 'bogo' ? 'selected' : ''}>BOGO</option>
                        <option value="b2g1" ${plan.promo_type === 'b2g1' ? 'selected' : ''}>Buy 2 Get 1</option>
                        <option value="25off" ${plan.promo_type === '25off' ? 'selected' : ''}>25% Off</option>
                    </select>
            `;

            if ((plan.winner === 'coca-cola' || plan.winner === 'pepsi') && plan.promo_type) {
                detailsHTML += `
                    <div class="tier-section">
                        <div class="tier-title">Tier 1A - Display/Feature/TPR</div>
                        <div class="tier-description">Primary promotion (min 2, max 3 groups)</div>
                        <div class="group-selector">
                            ${generateGroupCheckboxes('tier1a', weekKey, plan.tier1a || [], plan.winner)}
                        </div>
                    </div>
                    
                    <div class="tier-section">
                        <div class="tier-title">Tier 1B - Feature/TPR</div>
                        <div class="tier-description">Supporting promotion (min 1 group)</div>
                        <div class="group-selector">
                            ${generateGroupCheckboxes('tier1b', weekKey, plan.tier1b || [], plan.winner)}
                        </div>
                    </div>
                `;
            }

            if (plan.promo_type && plan.winner !== 'pl') {
                detailsHTML += `
                    <div class="cost-breakdown">
                        <div>
                            <strong>Retailer Cost:</strong><br>
                            ${calculateRetailerCost(weekKey, plan).toLocaleString()}
                        </div>
                        <div>
                            <strong>Mfr Funding:</strong><br>
                            ${calculateManufacturerFunding(weekKey, plan).toLocaleString()}
                        </div>
                    </div>
                `;
            } else if (plan.promo_type && plan.winner === 'pl') {
                detailsHTML += `
                    <div style="margin-top: 5px; font-size: 11px;">
                        <strong>Retailer Cost:</strong> ${calculateRetailerCost(weekKey, plan).toLocaleString()}<br>
                        <span style="color: #666;">(Retailer funds all PL promotions)</span>
                    </div>
                `;
            }

            detailsHTML += '</div>';
            detailsHTML += '<div class="tier-separator"></div>';

            detailsHTML += `
                <div class="tier-section">
                    <div class="tier-title">Tier 2 - Feature/TPR (Competitive Response)</div>
                    <div class="tier-description">Select brand allowed to have Tier 2 response</div>
                    <select onchange="updatePromoDetail('${weekKey}', 'tier2_allowed', this.value)" style="width: 100%; margin-bottom: 10px;">
                        <option value="">None</option>
                        ${plan.winner !== 'coca-cola' ? '<option value="coca-cola" ' + (plan.tier2_allowed === 'coca-cola' ? 'selected' : '') + '>Coca-Cola</option>' : ''}
                        ${plan.winner !== 'pepsi' ? '<option value="pepsi" ' + (plan.tier2_allowed === 'pepsi' ? 'selected' : '') + '>PepsiCo</option>' : ''}
                        ${plan.winner !== 'dps' ? '<option value="dps" ' + (plan.tier2_allowed === 'dps' ? 'selected' : '') + '>Dr Pepper Snapple</option>' : ''}
                        ${plan.winner !== 'pl' ? '<option value="pl" ' + (plan.tier2_allowed === 'pl' ? 'selected' : '') + '>Private Label</option>' : ''}
                    </select>
            `;

            if (plan.tier2_allowed) {
                if (plan.tier2_allowed === 'coca-cola' || plan.tier2_allowed === 'pepsi') {
                    detailsHTML += `
                        <select onchange="updatePromoDetail('${weekKey}', 'tier2_response', this.value)" style="width: 100%; margin-bottom: 5px;">
                            <option value="">Select Investment Level</option>
                            <option value="high" ${plan.tier2_response === 'high' ? 'selected' : ''}>High Investment (20%)</option>
                            <option value="low" ${plan.tier2_response === 'low' ? 'selected' : ''}>Low Investment (15%)</option>
                        </select>
                        ${plan.tier2_response ? `
                            <div class="tier-description">Select groups to promote:</div>
                            <div class="group-selector">
                                ${generateGroupCheckboxes('tier2_groups', weekKey, plan.tier2_groups || [], plan.tier2_allowed)}
                            </div>
                        ` : ''}
                    `;
                } else if (plan.tier2_allowed === 'dps' || plan.tier2_allowed === 'pl') {
                    detailsHTML += `
                        <select onchange="updatePromoDetail('${weekKey}', 'tier2_response', this.value)" style="width: 100%; margin-bottom: 5px;">
                            <option value="">Select Investment Level</option>
                            <option value="high" ${plan.tier2_response === 'high' ? 'selected' : ''}>High Investment (20%)</option>
                            <option value="low" ${plan.tier2_response === 'low' ? 'selected' : ''}>Low Investment (15%)</option>
                        </select>
                    `;
                    
                    if (plan.tier2_response) {
                        if (plan.tier2_allowed === 'pl') {
                            detailsHTML += `
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    Retailer funds all Private Label Tier 2 promotions
                                </div>
                            `;
                        } else if (plan.tier2_allowed === 'dps') {
                            detailsHTML += `
                                <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                    Dr Pepper Snapple funds this promotion (counts toward trade funding)
                                </div>
                            `;
                        }
                    }
                }
            }

            detailsHTML += '</div>';
            detailsHTML += '<div class="tier-separator"></div>';
            detailsHTML += generateTier3Section(weekKey, plan);

            const weekNum = parseInt(weekKey.split(' ')[1]);
            if (weekNum >= 14 && weekNum <= 22) {
                detailsHTML += generateSpecialInitiativesSection(weekKey, plan, true, true);
            } else {
                detailsHTML += generateSpecialInitiativesSection(weekKey, plan, true, false);
            }

            return detailsHTML;
        }

        function generateGroupCheckboxes(tier, weekKey, selectedGroups, brand) {
            if (!brand || !supersaverData.productGroups[brand]) return '';
            
            const groups = Object.keys(supersaverData.productGroups[brand]);
            return groups.map(group => `
                <div class="group-checkbox">
                    <input type="checkbox" 
                           id="${tier}-${weekKey}-${group}"
                           ${selectedGroups.includes(group) ? 'checked' : ''}
                           onchange="updateGroupSelection('${weekKey}', '${tier}', '${group}', this.checked)">
                    <label for="${tier}-${weekKey}-${group}">${group.split(' - ')[1]}</label>
                </div>
            `).join('');
        }

        function generateTier3Section(weekKey, plan) {
            let tier3HTML = '<div class="tier-section"><div class="tier-title">Tier 3 - TPR Only</div>';
            tier3HTML += '<div class="tier-description">Additional TPR for any non-promoted groups</div>';
            
            const promotedGroups = {};
            ['coca-cola', 'pepsi', 'dps', 'pl'].forEach(brand => {
                promotedGroups[brand] = [];
                
                if (plan.winner === brand) {
                    if (plan.tier1a) promotedGroups[brand] = promotedGroups[brand].concat(plan.tier1a);
                    if (plan.tier1b) promotedGroups[brand] = promotedGroups[brand].concat(plan.tier1b);
                }
                
                if (plan.tier2_allowed === brand && plan.tier2_groups) {
                    promotedGroups[brand] = promotedGroups[brand].concat(plan.tier2_groups);
                }
            });
            
            let hasUnpromotedGroups = false;
            ['coca-cola', 'pepsi', 'dps', 'pl'].forEach(brand => {
                const availableGroups = getAvailableGroupsForTier3(brand, promotedGroups[brand]);
                if (availableGroups.length > 0) {
                    hasUnpromotedGroups = true;
                }
            });
            
            if (!hasUnpromotedGroups) {
                tier3HTML += '<div style="font-size: 11px; color: #666;">All groups are already on Tier 1 or Tier 2 promotions</div>';
                tier3HTML += '</div>';
                return tier3HTML;
            }
            
            tier3HTML += `
                <label style="display: block; margin-bottom: 10px;">
                    <input type="checkbox" 
                           ${plan.tier3_enabled ? 'checked' : ''} 
                           onchange="updatePromoDetail('${weekKey}', 'tier3_enabled', this.checked)">
                    Enable Tier 3 TPR promotions
                </label>
            `;
            
            if (plan.tier3_enabled) {
                tier3HTML += '<table style="width: 100%; font-size: 11px; border-collapse: collapse;">';
                tier3HTML += '<tr><th style="text-align: left; padding: 5px;">Product Group</th><th style="text-align: center; padding: 5px;">High (10%)</th><th style="text-align: center; padding: 5px;">Low (5%)</th></tr>';
                
                ['coca-cola', 'pepsi', 'dps', 'pl'].forEach(brand => {
                    const availableGroups = getAvailableGroupsForTier3(brand, promotedGroups[brand]);
                    
                    availableGroups.forEach(group => {
                        const brandGroupKey = `${brand}-${group}`;
                        const currentInvestment = plan.tier3_investments && plan.tier3_investments[brandGroupKey];
                        let displayName = group.split(' - ')[1];
                        
                        if (group.includes('Other Brands')) {
                            if (brand === 'coca-cola') {
                                displayName = 'CC-' + displayName;
                            } else if (brand === 'pepsi') {
                                displayName = 'Pep-' + displayName;
                            }
                        }
                        
                        if (brand === 'dps') {
                            displayName = 'Dr Pepper Snapple';
                        } else if (brand === 'pl') {
                            displayName = 'Private Label';
                        }
                        
                        tier3HTML += `
                            <tr style="border-top: 1px solid #eee;">
                                <td style="padding: 5px;">${displayName}</td>
                                <td style="text-align: center; padding: 5px;">
                                    <input type="radio" 
                                           name="tier3-${weekKey}-${brand}-${group}" 
                                           value="high"
                                           ${currentInvestment === 'high' ? 'checked' : ''}
                                           data-week="${weekKey}"
                                           data-key="${brand}-${group}"
                                           data-level="high"
                                           onchange="handleTier3Change(this)">
                                </td>
                                <td style="text-align: center; padding: 5px;">
                                    <input type="radio" 
                                           name="tier3-${weekKey}-${brand}-${group}" 
                                           value="low"
                                           ${currentInvestment === 'low' ? 'checked' : ''}
                                           data-week="${weekKey}"
                                           data-key="${brand}-${group}"
                                           data-level="low"
                                           onchange="handleTier3Change(this)">
                                </td>
                            </tr>
                        `;
                    });
                });
                
                tier3HTML += '</table>';
                tier3HTML += `
                    <div style="margin-top: 5px; text-align: right;">
                        <button onclick="clearAllTier3('${weekKey}')" style="font-size: 10px; padding: 2px 5px;">Clear All</button>
                    </div>
                `;
            }
            
            tier3HTML += '</div>';
            return tier3HTML;
        }

        function generateSpecialInitiativesSection(weekKey, plan, loyaltyEligible, digitalEligible) {
            let initiativeHTML = '<div class="special-initiatives"><div class="initiative-title">Special Initiatives</div>';
            
            if (loyaltyEligible) {
                initiativeHTML += `
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 10px;">
                            <input type="checkbox" ${plan.loyalty_enabled ? 'checked' : ''} 
                                   onchange="updatePromoDetail('${weekKey}', 'loyalty_enabled', this.checked)">
                            <strong>Loyalty Program (Ongoing)</strong>
                        </label>
                        ${plan.loyalty_enabled ? generateInitiativeTable('loyalty', weekKey, plan) : ''}
                    </div>
                `;
            }
            
            if (digitalEligible) {
                initiativeHTML += `
                    <div>
                        <label style="display: block; margin-bottom: 10px;">
                            <input type="checkbox" ${plan.digital_enabled ? 'checked' : ''} 
                                   onchange="updatePromoDetail('${weekKey}', 'digital_enabled', this.checked)">
                            <strong>Digital Platform Launch</strong>
                        </label>
                        ${plan.digital_enabled ? generateInitiativeTable('digital', weekKey, plan) : ''}
                    </div>
                `;
            }
            
            initiativeHTML += '</div>';
            return initiativeHTML;
        }

        function generateInitiativeTable(initiative, weekKey, plan) {
            const tier1GroupsByBrand = {
                'coca-cola': [],
                'pepsi': [],
                'dps': [],
                'pl': []
            };
            
            if (plan.winner) {
                if (plan.tier1a) tier1GroupsByBrand[plan.winner] = tier1GroupsByBrand[plan.winner].concat(plan.tier1a);
                if (plan.tier1b) tier1GroupsByBrand[plan.winner] = tier1GroupsByBrand[plan.winner].concat(plan.tier1b);
            }
            
            const availableGroups = [];
            
            Object.keys(supersaverData.productGroups['coca-cola']).forEach(group => {
                const isOnCCTier1 = tier1GroupsByBrand['coca-cola'].includes(group);
                
                if (!isOnCCTier1) {
                    let displayName = group.split(' - ')[1];
                    let uniqueKey = group;
                    
                    if (group.includes('Other Brands')) {
                        displayName = 'CC-' + displayName;
                        uniqueKey = 'coca-cola-' + group;
                    }
                    
                    availableGroups.push({
                        key: uniqueKey,
                        originalKey: group,
                        display: displayName,
                        brand: 'coca-cola',
                        canMfrFund: true
                    });
                }
            });
            
            Object.keys(supersaverData.productGroups['pepsi']).forEach(group => {
                const isOnPepsiTier1 = tier1GroupsByBrand['pepsi'].includes(group);
                
                if (!isOnPepsiTier1) {
                    let displayName = group.split(' - ')[1];
                    let uniqueKey = group;
                    
                    if (group.includes('Other Brands')) {
                        displayName = 'Pep-' + displayName;
                        uniqueKey = 'pepsi-' + group;
                    }
                    
                    availableGroups.push({
                        key: uniqueKey,
                        originalKey: group,
                        display: displayName,
                        brand: 'pepsi',
                        canMfrFund: true
                    });
                }
            });
            
            if (plan.winner !== 'dps') {
                availableGroups.push({
                    key: 'DPS Brands',
                    originalKey: 'DPS Brands',
                    display: 'Dr Pepper Snapple',
                    brand: 'dps',
                    canMfrFund: false
                });
            }
            
            if (plan.winner !== 'pl') {
                availableGroups.push({
                    key: 'Private Label',
                    originalKey: 'Private Label',
                    display: 'Private Label',
                    brand: 'pl',
                    canMfrFund: false
                });
            }
            
            if (availableGroups.length === 0) {
                return '<div style="font-size: 11px; color: #666; margin-left: 20px;">All groups are on Tier 1 promotions</div>';
            }
            
            let tableHTML = `
                <div style="margin-left: 20px;">
                    <table style="width: 100%; font-size: 11px; border-collapse: collapse; margin-top: 10px;">
                        <tr>
                            <th style="text-align: left; padding: 5px; border-bottom: 1px solid #ddd;">Product Group</th>
                            <th style="text-align: center; padding: 5px; border-bottom: 1px solid #ddd;">Retailer Only</th>
                            <th style="text-align: center; padding: 5px; border-bottom: 1px solid #ddd;">50/50 Split</th>
                            <th style="text-align: center; padding: 5px; border-bottom: 1px solid #ddd;">Mfr Only</th>
                        </tr>
            `;
            
            availableGroups.forEach(group => {
                const fundingKey = initiative + '_funding';
                const currentFunding = plan[fundingKey] && plan[fundingKey][group.key];
                const rowClass = group.canMfrFund ? '' : 'style="background-color: #f8f8f8;"';
                
                tableHTML += `
                    <tr ${rowClass}>
                        <td style="padding: 5px; border-top: 1px solid #eee;">${group.display}</td>
                        <td style="text-align: center; padding: 5px; border-top: 1px solid #eee;">
                            <input type="radio" 
                                   name="${initiative}-${weekKey}-${group.key}" 
                                   value="retailer"
                                   ${currentFunding === 'retailer' ? 'checked' : ''}
                                   onchange="updateInitiativeFunding('${weekKey}', '${initiative}', '${group.key}', 'retailer', '${group.brand}', '${group.originalKey}')">
                        </td>
                        <td style="text-align: center; padding: 5px; border-top: 1px solid #eee;">
                            <input type="radio" 
                                   name="${initiative}-${weekKey}-${group.key}" 
                                   value="split"
                                   ${currentFunding === 'split' ? 'checked' : ''}
                                   ${group.canMfrFund ? '' : 'disabled'}
                                   onchange="updateInitiativeFunding('${weekKey}', '${initiative}', '${group.key}', 'split', '${group.brand}', '${group.originalKey}')">
                        </td>
                        <td style="text-align: center; padding: 5px; border-top: 1px solid #eee;">
                            <input type="radio" 
                                   name="${initiative}-${weekKey}-${group.key}" 
                                   value="manufacturer"
                                   ${currentFunding === 'manufacturer' ? 'checked' : ''}
                                   ${group.canMfrFund ? '' : 'disabled'}
                                   onchange="updateInitiativeFunding('${weekKey}', '${initiative}', '${group.key}', 'manufacturer', '${group.brand}', '${group.originalKey}')">
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </table>
                    <div style="margin-top: 5px; text-align: right;">
                        <button onclick="clearAllInitiatives('${weekKey}', '${initiative}')" style="font-size: 10px; padding: 2px 5px;">Clear All</button>
                    </div>
                    <div style="font-size: 10px; color: #666; margin-top: 5px;">
                        <strong>Note:</strong> DPS and Private Label can only be retailer-funded
                    </div>
                </div>
            `;
            
            return tableHTML;
        }

        function getAvailableGroupsForTier3(brand, promotedGroups) {
            if (!brand || !supersaverData.productGroups[brand]) return [];
            const allGroups = Object.keys(supersaverData.productGroups[brand]);
            return allGroups.filter(group => !promotedGroups.includes(group));
        }

        function updateWeekWinner(week, winner) {
            if (!weeklyPlans[week]) {
                weeklyPlans[week] = {};
            }
            
            const isHoliday = supersaverData.holidayMultipliers[week] > 1.0;
            if (winner === 'dps' && isHoliday) {
                alert('DPS cannot have Tier 1 display during holiday weeks');
                event.target.value = weeklyPlans[week].winner || '';
                return;
            }
            
            if (!winner || winner === '') {
                weeklyPlans[week] = {};
            } else {
                weeklyPlans[week].winner = winner;
                
                if (!weeklyPlans[week].display_type) {
                    weeklyPlans[week].display_type = 'endcap';
                }
            }
            
            generateWeekGrid();
            updateDashboard();
            saveToFirebase();
        }

        function updatePromoDetail(week, field, value) {
            if (!weeklyPlans[week]) {
                weeklyPlans[week] = {};
            }
            weeklyPlans[week][field] = value;
            
            const detailsDiv = document.getElementById('week-' + week.replace(/[\s()]/g, '_') + '-details');
            if (detailsDiv) {
                detailsDiv.innerHTML = generateWeekDetails(week, weeklyPlans[week]);
            }
            
            updateDashboard();
            saveToFirebase();
        }

        function updateGroupSelection(week, tier, group, selected) {
            if (!weeklyPlans[week]) {
                weeklyPlans[week] = {};
            }
            
            const plan = weeklyPlans[week];
            
            if (tier === 'tier1a' && selected && plan.tier1b && plan.tier1b.includes(group)) {
                alert(group.split(' - ')[1] + ' is already in Tier 1B. A product group can only be in either Tier 1A or Tier 1B, not both.');
                event.target.checked = false;
                return;
            }
            
            if (tier === 'tier1b' && selected && plan.tier1a && plan.tier1a.includes(group)) {
                alert(group.split(' - ')[1] + ' is already in Tier 1A. A product group can only be in either Tier 1A or Tier 1B, not both.');
                event.target.checked = false;
                return;
            }
            
            if (tier === 'tier2_groups') {
                if (!plan.tier2_groups) plan.tier2_groups = [];
                
                if (selected) {
                    if (!plan.tier2_groups.includes(group)) {
                        plan.tier2_groups.push(group);
                    }
                } else {
                    plan.tier2_groups = plan.tier2_groups.filter(g => g !== group);
                }
            } else {
                if (!plan[tier]) plan[tier] = [];

                if (selected) {
                    if (!plan[tier].includes(group)) {
                        plan[tier].push(group);
                    }
                } else {
                    plan[tier] = plan[tier].filter(g => g !== group);
                }
            }

            const detailsDiv = document.getElementById('week-' + week.replace(/[\s()]/g, '_') + '-details');
            if (detailsDiv) {
                detailsDiv.innerHTML = generateWeekDetails(week, plan);
            }

            updateDashboard();
            saveToFirebase();
        }

        function clearAllTier3(week) {
            if (weeklyPlans[week]) {
                weeklyPlans[week].tier3_investments = {};
                const detailsDiv = document.getElementById('week-' + week.replace(/[\s()]/g, '_') + '-details');
                if (detailsDiv) {
                    detailsDiv.innerHTML = generateWeekDetails(week, weeklyPlans[week]);
                }
                updateDashboard();
                saveToFirebase();
            }
        }

        function updateInitiativeFunding(week, initiative, group, funding, brand, originalKey) {
            if (!weeklyPlans[week]) {
                weeklyPlans[week] = {};
            }
            
            const plan = weeklyPlans[week];
            const fundingKey = initiative + '_funding';
            if (!plan[fundingKey]) plan[fundingKey] = {};
            
            if (funding) {
                plan[fundingKey][group] = funding;
                
                const brandContextKey = initiative + '_brand_context';
                if (!plan[brandContextKey]) plan[brandContextKey] = {};
                plan[brandContextKey][group] = {
                    brand: brand,
                    originalKey: originalKey
                };
            } else {
                delete plan[fundingKey][group];
                
                const brandContextKey = initiative + '_brand_context';
                if (plan[brandContextKey]) {
                    delete plan[brandContextKey][group];
                }
            }
            
            updateDashboard();
            saveToFirebase();
        }

        function clearAllInitiatives(week, initiative) {
            if (weeklyPlans[week]) {
                weeklyPlans[week][initiative + '_funding'] = {};
                const detailsDiv = document.getElementById('week-' + week.replace(/[\s()]/g, '_') + '-details');
                if (detailsDiv) {
                    detailsDiv.innerHTML = generateWeekDetails(week, weeklyPlans[week]);
                }
                updateDashboard();
                saveToFirebase();
            }
        }

        function handleTier3Change(element) {
            const week = element.dataset.week;
            const key = element.dataset.key;
            const level = element.dataset.level;
            
            if (!weeklyPlans[week]) {
                weeklyPlans[week] = {};
            }
            
            const plan = weeklyPlans[week];
            if (!plan.tier3_investments) plan.tier3_investments = {};
            
            if (element.checked) {
                plan.tier3_investments[key] = level;
            } else {
                delete plan.tier3_investments[key];
            }
            
            updateDashboard();
            saveToFirebase();
        }

        function calculateRetailerCost(week, plan) {
            if (!plan.winner || !plan.promo_type) return 0;
            
            const holidayMult = supersaverData.holidayMultipliers[week] || 1.0;
            const displayMult = supersaverData.displayMultipliers[plan.display_type] || 1.0;
            
            if (plan.winner === 'pl') {
                const baseline = supersaverData.baselines[plan.winner];
                const lift = supersaverData.promotionalLifts.tier1a[plan.promo_type];
                const promotionalSales = baseline.retail * lift * displayMult * holidayMult;
                const plCostRate = plan.promo_type === 'bogo' ? 0.50 : 
                                  plan.promo_type === 'b2g1' ? 0.3333 : 0.25;
                return Math.round(promotionalSales * plCostRate);
            }
            
            if (plan.winner === 'dps') {
                const baseline = supersaverData.baselines[plan.winner];
                const lift = supersaverData.promotionalLifts.tier1a[plan.promo_type];
                const promotionalSales = baseline.retail * lift * displayMult * holidayMult;
                const retailerShare = supersaverData.costSharing[plan.promo_type].retailer;
                return Math.round(promotionalSales * retailerShare);
            }
            
            if (plan.winner === 'coca-cola' || plan.winner === 'pepsi') {
                let totalRetailerCost = 0;
                const retailerShare = supersaverData.costSharing[plan.promo_type].retailer;
                const productGroups = supersaverData.productGroups[plan.winner];
                
                if (plan.tier1a && plan.tier1a.length > 0) {
                    const lift = supersaverData.promotionalLifts.tier1a[plan.promo_type];
                    plan.tier1a.forEach(group => {
                        if (productGroups[group]) {
                            const groupRetail = productGroups[group].retail;
                            const promotionalSales = groupRetail * lift * displayMult * holidayMult;
                            totalRetailerCost += promotionalSales * retailerShare;
                        }
                    });
                }
                
                if (plan.tier1b && plan.tier1b.length > 0) {
                    const lift = supersaverData.promotionalLifts.tier1b[plan.promo_type];
                    plan.tier1b.forEach(group => {
                        if (productGroups[group]) {
                            const groupRetail = productGroups[group].retail;
                            const promotionalSales = groupRetail * lift * displayMult * holidayMult;
                            totalRetailerCost += promotionalSales * retailerShare;
                        }
                    });
                }
                
                return Math.round(totalRetailerCost);
            }
            
            return 0;
        }

        function calculateManufacturerFunding(week, plan) {
            if (!plan.winner || !plan.promo_type || plan.winner === 'pl') return 0;
            
            const holidayMult = supersaverData.holidayMultipliers[week] || 1.0;
            const displayMult = supersaverData.displayMultipliers[plan.display_type] || 1.0;
            
            if (plan.winner === 'dps') {
                const baseline = supersaverData.baselines[plan.winner];
                const lift = supersaverData.promotionalLifts.tier1a[plan.promo_type];
                const promotionalSales = baseline.retail * lift * displayMult * holidayMult;
                const mfrShare = supersaverData.costSharing[plan.promo_type].manufacturer;
                return Math.round(promotionalSales * mfrShare);
            }
            
            if (plan.winner === 'coca-cola' || plan.winner === 'pepsi') {
                let totalMfrCost = 0;
                const mfrShare = supersaverData.costSharing[plan.promo_type].manufacturer;
                const productGroups = supersaverData.productGroups[plan.winner];
                
                if (plan.tier1a && plan.tier1a.length > 0) {
                    const lift = supersaverData.promotionalLifts.tier1a[plan.promo_type];
                    plan.tier1a.forEach(group => {
                        if (productGroups[group]) {
                            const groupRetail = productGroups[group].retail;
                            const promotionalSales = groupRetail * lift * displayMult * holidayMult;
                            totalMfrCost += promotionalSales * mfrShare;
                        }
                    });
                }
                
                if (plan.tier1b && plan.tier1b.length > 0) {
                    const lift = supersaverData.promotionalLifts.tier1b[plan.promo_type];
                    plan.tier1b.forEach(group => {
                        if (productGroups[group]) {
                            const groupRetail = productGroups[group].retail;
                            const promotionalSales = groupRetail * lift * displayMult * holidayMult;
                            totalMfrCost += promotionalSales * mfrShare;
                        }
                    });
                }
                
                return Math.round(totalMfrCost);
            }
            
            return 0;
        }

        function calculateWeeklySales(week, plan) {
            let totalNetSales = 0;
            let retailerCost = 0;
            const holidayMult = supersaverData.holidayMultipliers[week] || 1.0;
            
            if (!plan || Object.keys(plan).length === 0 || !plan.winner) {
                Object.keys(supersaverData.baselines).forEach(brand => {
                    const baseline = supersaverData.baselines[brand];
                    totalNetSales += baseline.retail * holidayMult;
                });
                return { netSales: totalNetSales, retailerCost: retailerCost };
            }
            
            Object.keys(supersaverData.baselines).forEach(brand => {
                const baseline = supersaverData.baselines[brand];
                const productGroups = supersaverData.productGroups[brand];
                
                if (brand === 'pl' || brand === 'dps') {
                    let brandNetSales = 0;
                    let hasSpecialInitiative = false;
                    
                    const groupKey = brand === 'dps' ? 'DPS Brands' : 'Private Label';
                    const brandGroupKey = `${brand}-${groupKey}`;
                    
                    if (plan.loyalty_funding) {
                        if (plan.loyalty_funding[groupKey] || plan.loyalty_funding[brandGroupKey]) {
                            hasSpecialInitiative = true;
                        }
                    }
                    
                    if (!hasSpecialInitiative && plan.digital_funding) {
                        if (plan.digital_funding[groupKey] || plan.digital_funding[brandGroupKey]) {
                            hasSpecialInitiative = true;
                        }
                    }
                    
                    if (brand === plan.winner && plan.promo_type) {
                        const displayMult = supersaverData.displayMultipliers[plan.display_type] || 1.0;
                        const lift = supersaverData.promotionalLifts.tier1a[plan.promo_type];
                        const grossSales = baseline.retail * lift * displayMult * holidayMult;
                        
                        if (plan.promo_type === 'bogo') {
                            brandNetSales = grossSales * 0.50;
                        } else if (plan.promo_type === 'b2g1') {
                            brandNetSales = grossSales * 0.6667;
                        } else if (plan.promo_type === '25off') {
                            brandNetSales = grossSales * 0.75;
                        }
                        
                        if (brand === 'pl') {
                            const plCostRate = plan.promo_type === 'bogo' ? 0.50 : 
                                             plan.promo_type === 'b2g1' ? 0.3333 : 0.25;
                            retailerCost += grossSales * plCostRate;
                        } else {
                            const retailerShare = supersaverData.costSharing[plan.promo_type].retailer;
                            retailerCost += grossSales * retailerShare;
                        }
                        
                    } else if (brand === plan.tier2_allowed && plan.tier2_response) {
                        const baseLift = supersaverData.promotionalLifts.tier2[plan.tier2_response];
                        const tier2Discount = plan.tier2_response === 'high' ? 0.20 : 0.15;
                        
                        if (hasSpecialInitiative) {
                            const baseGrossVolume = baseline.retail * baseLift * holidayMult;
                            const incrementalGrossVolume = baseline.retail * (baseLift * 1.3 - baseLift) * holidayMult;
                            
                            const baseNetSales = baseGrossVolume * (1 - tier2Discount);
                            const incrementalNetSales = incrementalGrossVolume * (1 - 0.20);
                            
                            brandNetSales = baseNetSales + incrementalNetSales;
                        } else {
                            const grossSales = baseline.retail * baseLift * holidayMult;
                            brandNetSales = grossSales * (1 - tier2Discount);
                        }
                        
                        if (brand === 'pl') {
                            const baseGrossSales = baseline.retail * baseLift * holidayMult;
                            const plDiscountRate = plan.tier2_response === 'high' ? 0.20 : 0.15;
                            const plTier2Cost = baseGrossSales * plDiscountRate;
                            retailerCost += plTier2Cost;
                        }
                        
                    } else if (plan.tier3_investments && (plan.tier3_investments[groupKey] || plan.tier3_investments[brandGroupKey])) {
                        const investment = plan.tier3_investments[groupKey] || plan.tier3_investments[brandGroupKey];
                        const baseLift = supersaverData.promotionalLifts.tier3[investment];
                        const tier3Discount = investment === 'high' ? 0.10 : 0.05;
                        
                        if (hasSpecialInitiative) {
                            const baseGrossVolume = baseline.retail * baseLift * holidayMult;
                            const incrementalGrossVolume = baseline.retail * (baseLift * 1.9 - baseLift) * holidayMult;
                            
                            const baseNetSales = baseGrossVolume * (1 - tier3Discount);
                            const incrementalNetSales = incrementalGrossVolume * (1 - 0.20);
                            
                            brandNetSales = baseNetSales + incrementalNetSales;
                        } else {
                            const grossSales = baseline.retail * baseLift * holidayMult;
                            brandNetSales = grossSales * (1 - tier3Discount);
                        }
                        
                        if (brand === 'pl') {
                            const grossSales = baseline.retail * baseLift * holidayMult;
                            retailerCost += grossSales * tier3Discount;
                        }
                        
                    } else if (hasSpecialInitiative) {
                        const lift = 2.5;
                        const grossSales = baseline.retail * lift * holidayMult;
                        brandNetSales = grossSales * 0.80;
                        
                    } else {
                        brandNetSales = baseline.retail * holidayMult;
                    }
                    
                    totalNetSales += brandNetSales;
                    
                } else if (brand === 'coca-cola' || brand === 'pepsi') {
                    Object.keys(productGroups).forEach(group => {
                        const groupData = productGroups[group];
                        let groupNetSales = 0;
                        let hasSpecialInitiative = false;
                        
                        const brandSpecificKey = `${brand}-${group}`;
                        
                        if (plan.loyalty_funding) {
                            if (plan.loyalty_funding[group]) {
                                hasSpecialInitiative = true;
                            } else if (plan.loyalty_funding[brandSpecificKey]) {
                                hasSpecialInitiative = true;
                            }
                        }
                        
                        if (!hasSpecialInitiative && plan.digital_funding) {
                            if (plan.digital_funding[group]) {
                                hasSpecialInitiative = true;
                            } else if (plan.digital_funding[brandSpecificKey]) {
                                hasSpecialInitiative = true;
                            }
                        }
                        
                        if (brand === plan.winner && plan.promo_type && plan.tier1a?.includes(group)) {
                            const displayMult = supersaverData.displayMultipliers[plan.display_type] || 1.0;
                            const lift = supersaverData.promotionalLifts.tier1a[plan.promo_type];
                            const grossSales = groupData.retail * lift * displayMult * holidayMult;
                            
                            if (plan.promo_type === 'bogo') {
                                groupNetSales = grossSales * 0.50;
                            } else if (plan.promo_type === 'b2g1') {
                                groupNetSales = grossSales * 0.6667;
                            } else if (plan.promo_type === '25off') {
                                groupNetSales = grossSales * 0.75;
                            }
                            
                            const retailerShare = supersaverData.costSharing[plan.promo_type].retailer;
                            retailerCost += grossSales * retailerShare;
                            
                        } else if (brand === plan.winner && plan.promo_type && plan.tier1b?.includes(group)) {
                            const displayMult = supersaverData.displayMultipliers[plan.display_type] || 1.0;
                            const lift = supersaverData.promotionalLifts.tier1b[plan.promo_type];
                            const grossSales = groupData.retail * lift * displayMult * holidayMult;
                            
                            if (plan.promo_type === 'bogo') {
                                groupNetSales = grossSales * 0.50;
                            } else if (plan.promo_type === 'b2g1') {
                                groupNetSales = grossSales * 0.6667;
                            } else if (plan.promo_type === '25off') {
                                groupNetSales = grossSales * 0.75;
                            }
                            
                            const retailerShare = supersaverData.costSharing[plan.promo_type].retailer;
                            retailerCost += grossSales * retailerShare;
                            
                        } else if (brand === plan.tier2_allowed && plan.tier2_groups?.includes(group)) {
                            const baseLift = supersaverData.promotionalLifts.tier2[plan.tier2_response];
                            const tier2Discount = plan.tier2_response === 'high' ? 0.20 : 0.15;
                            
                            if (hasSpecialInitiative) {
                                const baseGrossVolume = groupData.retail * baseLift * holidayMult;
                                const incrementalGrossVolume = groupData.retail * (baseLift * 1.3 - baseLift) * holidayMult;
                                
                                const baseNetSales = baseGrossVolume * (1 - tier2Discount);
                                const incrementalNetSales = incrementalGrossVolume * (1 - 0.20);
                                
                                groupNetSales = baseNetSales + incrementalNetSales;
                            } else {
                                const grossSales = groupData.retail * baseLift * holidayMult;
                                groupNetSales = grossSales * (1 - tier2Discount);
                            }
                            
                        } else if (plan.tier3_investments && plan.tier3_investments[brand + '-' + group]) {
                            const investment = plan.tier3_investments[brand + '-' + group];
                            const baseLift = supersaverData.promotionalLifts.tier3[investment];
                            const tier3Discount = investment === 'high' ? 0.10 : 0.05;
                            
                            if (hasSpecialInitiative) {
                                const baseGrossVolume = groupData.retail * baseLift * holidayMult;
                                const incrementalGrossVolume = groupData.retail * (baseLift * 1.9 - baseLift) * holidayMult;
                                
                                const baseNetSales = baseGrossVolume * (1 - tier3Discount);
                                const incrementalNetSales = incrementalGrossVolume * (1 - 0.20);
                                
                                groupNetSales = baseNetSales + incrementalNetSales;
                            } else {
                                const grossSales = groupData.retail * baseLift * holidayMult;
                                groupNetSales = grossSales * (1 - tier3Discount);
                            }
                            
                        } else if (hasSpecialInitiative) {
                            const lift = 2.5;
                            const grossSales = groupData.retail * lift * holidayMult;
                            groupNetSales = grossSales * 0.80;
                            
                        } else {
                            groupNetSales = groupData.retail * holidayMult;
                        }
                        
                        totalNetSales += groupNetSales;
                    });
                }
            });
            
            return { netSales: totalNetSales, retailerCost: retailerCost };
        }

        function updateDashboard() {
            let totalRetailerCost = 0;
            let totalManufacturerFunding = 0;
            let totalSales = 0;
            let weekCounts = {
                'coca-cola': { tier1: 0, tier2: 0 },
                'pepsi': { tier1: 0, tier2: 0 },
                'dps': { tier1: 0, tier2: 0 },
                'pl': { tier1: 0, tier2: 0 }
            };
            let promoWeekCount = 0;
            specialInitiativeSpend = { digital: 0, loyalty: 0 };
            
            let totalBaselineSales = 0;
            
            for (let week = 1; week <= 26; week++) {
                const weekKey = `Week ${week}`;
                const plan = weeklyPlans[weekKey] || {};
                const holidayMult = supersaverData.holidayMultipliers[weekKey] || 1.0;
                
                let weekBaselineSales = 0;
                Object.keys(supersaverData.baselines).forEach(brand => {
                    const baseline = supersaverData.baselines[brand];
                    weekBaselineSales += baseline.retail * holidayMult;
                });
                totalBaselineSales += weekBaselineSales;
                
                if (plan.winner) {
                    weekCounts[plan.winner].tier1++;
                    promoWeekCount++;
                    
                    if (plan.promo_type) {
                        totalManufacturerFunding += calculateManufacturerFunding(weekKey, plan);
                    }
                }
                
                if (plan.tier2_allowed && plan.tier2_response) {
                    if (weekCounts[plan.tier2_allowed]) {
                        weekCounts[plan.tier2_allowed].tier2++;
                    }
                    
                    if (plan.tier2_allowed === 'coca-cola' || plan.tier2_allowed === 'pepsi') {
                        if (plan.tier2_groups && plan.tier2_groups.length > 0) {
                            const lift = supersaverData.promotionalLifts.tier2[plan.tier2_response];
                            const tier2Discount = plan.tier2_response === 'high' ? 0.20 : 0.15;
                            const productGroups = supersaverData.productGroups[plan.tier2_allowed];
                            
                            plan.tier2_groups.forEach(group => {
                                if (productGroups[group]) {
                                    const groupRetail = productGroups[group].retail;
                                    const promotionalSales = groupRetail * lift * holidayMult;
                                    const tier2MfrFunding = Math.round(promotionalSales * tier2Discount);
                                    totalManufacturerFunding += tier2MfrFunding;
                                }
                            });
                        }
                    } else if (plan.tier2_allowed === 'dps') {
                        const baseline = supersaverData.baselines['dps'];
                        const lift = supersaverData.promotionalLifts.tier2[plan.tier2_response];
                        const promotionalSales = baseline.retail * lift * holidayMult;
                        const dpsDiscountRate = plan.tier2_response === 'high' ? 0.20 : 0.15;
                        totalManufacturerFunding += Math.round(promotionalSales * dpsDiscountRate);
                    }
                }
                
                if (plan.tier3_investments) {
                    Object.keys(plan.tier3_investments).forEach(investmentKey => {
                        const investment = plan.tier3_investments[investmentKey];
                        
                        let brand = null;
                        let group = null;
                        
                        ['coca-cola', 'pepsi', 'dps', 'pl'].forEach(brandName => {
                            if (investmentKey.startsWith(brandName + '-')) {
                                const potentialGroup = investmentKey.substring(brandName.length + 1);
                                if (supersaverData.productGroups[brandName] && supersaverData.productGroups[brandName][potentialGroup]) {
                                    brand = brandName;
                                    group = potentialGroup;
                                }
                            }
                        });
                        
                        if (brand && group && brand !== 'pl') {
                            const groupData = supersaverData.productGroups[brand][group];
                            const lift = supersaverData.promotionalLifts.tier3[investment];
                            const grossSales = groupData.retail * lift * holidayMult;
                            const tier3Rate = investment === 'high' ? 0.10 : 0.05;
                            const tier3Cost = Math.round(grossSales * tier3Rate);
                            totalManufacturerFunding += tier3Cost;
                        }
                    });
                }
                
                ['loyalty_funding', 'digital_funding'].forEach(fundingType => {
                    if (plan[fundingType]) {
                        Object.keys(plan[fundingType]).forEach(group => {
                            const funding = plan[fundingType][group];
                            let groupRetail = 0;
                            let brandForGroup = null;
                            let originalKey = group;
                            
                            const contextKey = fundingType.replace('_funding', '_brand_context');
                            if (plan[contextKey] && plan[contextKey][group]) {
                                brandForGroup = plan[contextKey][group].brand;
                                originalKey = plan[contextKey][group].originalKey;
                            } else {
                                Object.keys(supersaverData.productGroups).forEach(brand => {
                                    if (supersaverData.productGroups[brand][group]) {
                                        brandForGroup = brand;
                                        originalKey = group;
                                    }
                                });
                                if (group.includes('coca-cola-') || group.includes('pepsi-')) {
                                    const parts = group.split('-');
                                    brandForGroup = parts[0];
                                    originalKey = parts.slice(1).join('-');
                                }
                            }
                            
                            if (brandForGroup && supersaverData.productGroups[brandForGroup] && supersaverData.productGroups[brandForGroup][originalKey]) {
                                groupRetail = supersaverData.productGroups[brandForGroup][originalKey].retail;
                            }
                            
                            if (groupRetail > 0) {
                                let costBasis = 0;
                                
                                if (plan.tier2_groups?.includes(originalKey)) {
                                    const baseLift = supersaverData.promotionalLifts.tier2[plan.tier2_response];
                                    const totalLift = baseLift * 1.3;
                                    const incrementalLift = totalLift - baseLift;
                                    costBasis = groupRetail * incrementalLift * holidayMult;
                                } else if (plan.tier3_investments) {
                                    const tier3Key = `${brandForGroup}-${originalKey}`;
                                    if (plan.tier3_investments[tier3Key]) {
                                        const baseLift = supersaverData.promotionalLifts.tier3[plan.tier3_investments[tier3Key]];
                                        const totalLift = baseLift * 1.9;
                                        const incrementalLift = totalLift - baseLift;
                                        costBasis = groupRetail * incrementalLift * holidayMult;
                                    } else {
                                        costBasis = groupRetail * 2.5 * holidayMult;
                                    }
                                } else {
                                    costBasis = groupRetail * 2.5 * holidayMult;
                                }
                                
                                if (funding === 'manufacturer') {
                                    const mfrCost = Math.round(costBasis * 0.20);
                                    totalManufacturerFunding += mfrCost;
                                } else if (funding === 'split') {
                                    const mfrCost = Math.round(costBasis * 0.10);
                                    totalManufacturerFunding += mfrCost;
                                    const retailerCost = Math.round(costBasis * 0.10);
                                    if (fundingType === 'loyalty_funding') {
                                        specialInitiativeSpend.loyalty += retailerCost;
                                    } else {
                                        specialInitiativeSpend.digital += retailerCost;
                                    }
                                } else if (funding === 'retailer') {
                                    const retailerCost = Math.round(costBasis * 0.20);
                                    if (fundingType === 'loyalty_funding') {
                                        specialInitiativeSpend.loyalty += retailerCost;
                                    } else {
                                        specialInitiativeSpend.digital += retailerCost;
                                    }
                                }
                            }
                        });
                    }
                });
                
                const result = calculateWeeklySales(weekKey, plan);
                totalSales += result.netSales;
                totalRetailerCost += result.retailerCost;
            }
            
            const totalSpecialInitiativeRetailerCost = specialInitiativeSpend.digital + specialInitiativeSpend.loyalty;
            const finalTotalRetailerCost = totalRetailerCost + totalSpecialInitiativeRetailerCost;
            
            document.getElementById('total-retailer-cost').textContent = `${Math.round(finalTotalRetailerCost).toLocaleString()}`;
            document.getElementById('avg-weekly-cost').textContent = `${Math.round(finalTotalRetailerCost / 26).toLocaleString()}`;
            
            document.getElementById('digital-budget').textContent = 
                `${Math.round(specialInitiativeSpend.digital).toLocaleString()} / $900,000 min`;
            document.getElementById('loyalty-budget').textContent = 
                `${Math.round(specialInitiativeSpend.loyalty).toLocaleString()} / $500,000 min`;
            
            document.getElementById('total-sales').textContent = `${Math.round(totalSales).toLocaleString()}`;
            document.getElementById('promo-weeks').textContent = `${promoWeekCount} / 26`;
            
            const priorYearSales = 180000000;
            const growthRate = ((totalSales - priorYearSales) / priorYearSales * 100);
            document.getElementById('sales-growth').textContent = `${growthRate.toFixed(1)}%`;
            document.getElementById('obj-growth').textContent = `${growthRate.toFixed(1)}%`;
            
            document.getElementById('obj-funding').textContent = `${(totalManufacturerFunding / 1000000).toFixed(1)}M`;
            document.getElementById('funding-exact').textContent = `Exact: ${totalManufacturerFunding.toLocaleString()}`;
            
            updateBrandWeekDisplay('cc-weeks', weekCounts['coca-cola'], 10, 15);
            updateBrandWeekDisplay('pepsi-weeks', weekCounts['pepsi'], 10, 15);
            updateBrandWeekDisplay('dps-weeks', weekCounts['dps'], 1, 2, 6);
            updateBrandWeekDisplay('pl-weeks', weekCounts['pl'], 2, 3, 5, 6);
            
            const baseMargins = {
                'coca-cola': 0.25,
                'pepsi': 0.22,
                'dps': 0.27,
                'pl': 0.38
            };
            
            let actualNetSales = {
                'coca-cola': 0,
                'pepsi': 0,
                'dps': 0,
                'pl': 0
            };
            
            for (let week = 1; week <= 26; week++) {
                const weekKey = `Week ${week}`;
                const plan = weeklyPlans[weekKey] || {};
                const holidayMult = supersaverData.holidayMultipliers[weekKey] || 1.0;
                
                Object.keys(supersaverData.baselines).forEach(brand => {
                    const baseline = supersaverData.baselines[brand];
                    const productGroups = supersaverData.productGroups[brand];
                    
                    if (brand === 'pl' || brand === 'dps') {
                        let brandNetSales = 0;
                        let hasSpecialInitiative = false;
                        
                        const groupKey = brand === 'dps' ? 'DPS Brands' : 'Private Label';
                        const brandGroupKey = `${brand}-${groupKey}`;
                        
                        if (plan.loyalty_funding && (plan.loyalty_funding[groupKey] || plan.loyalty_funding[brandGroupKey])) {
                            hasSpecialInitiative = true;
                        }
                        if (!hasSpecialInitiative && plan.digital_funding && (plan.digital_funding[groupKey] || plan.digital_funding[brandGroupKey])) {
                            hasSpecialInitiative = true;
                        }
                        
                        if (brand === plan.winner && plan.promo_type) {
                            const displayMult = supersaverData.displayMultipliers[plan.display_type] || 1.0;
                            const lift = supersaverData.promotionalLifts.tier1a[plan.promo_type];
                            const grossSales = baseline.retail * lift * displayMult * holidayMult;
                            
                            if (plan.promo_type === 'bogo') {
                                brandNetSales = grossSales * 0.50;
                            } else if (plan.promo_type === 'b2g1') {
                                brandNetSales = grossSales * 0.6667;
                            } else if (plan.promo_type === '25off') {
                                brandNetSales = grossSales * 0.75;
                            }
                        } else if (brand === plan.tier2_allowed && plan.tier2_response) {
                            const baseLift = supersaverData.promotionalLifts.tier2[plan.tier2_response];
                            const tier2Discount = plan.tier2_response === 'high' ? 0.20 : 0.15;
                            
                            if (hasSpecialInitiative) {
                                const baseGrossVolume = baseline.retail * baseLift * holidayMult;
                                const incrementalGrossVolume = baseline.retail * (baseLift * 1.3 - baseLift) * holidayMult;
                                const baseNetSales = baseGrossVolume * (1 - tier2Discount);
                                const incrementalNetSales = incrementalGrossVolume * (1 - 0.20);
                                brandNetSales = baseNetSales + incrementalNetSales;
                            } else {
                                const grossSales = baseline.retail * baseLift * holidayMult;
                                brandNetSales = grossSales * (1 - tier2Discount);
                            }
                        } else if (plan.tier3_investments && (plan.tier3_investments[groupKey] || plan.tier3_investments[brandGroupKey])) {
                            const investment = plan.tier3_investments[groupKey] || plan.tier3_investments[brandGroupKey];
                            const baseLift = supersaverData.promotionalLifts.tier3[investment];
                            const tier3Discount = investment === 'high' ? 0.10 : 0.05;
                            
                            if (hasSpecialInitiative) {
                                const baseGrossVolume = baseline.retail * baseLift * holidayMult;
                                const incrementalGrossVolume = baseline.retail * (baseLift * 1.9 - baseLift) * holidayMult;
                                const baseNetSales = baseGrossVolume * (1 - tier3Discount);
                                const incrementalNetSales = incrementalGrossVolume * (1 - 0.20);
                                brandNetSales = baseNetSales + incrementalNetSales;
                            } else {
                                const grossSales = baseline.retail * baseLift * holidayMult;
                                brandNetSales = grossSales * (1 - tier3Discount);
                            }
                        } else if (hasSpecialInitiative) {
                            const lift = 2.5;
                            const grossSales = baseline.retail * lift * holidayMult;
                            brandNetSales = grossSales * 0.80;
                        } else {
                            brandNetSales = baseline.retail * holidayMult;
                        }
                        
                        actualNetSales[brand] += brandNetSales;
                        
                    } else if (brand === 'coca-cola' || brand === 'pepsi') {
                        Object.keys(productGroups).forEach(group => {
                            const groupData = productGroups[group];
                            let groupNetSales = 0;
                            let hasSpecialInitiative = false;
                            
                            const brandSpecificKey = `${brand}-${group}`;
                            if (plan.loyalty_funding && (plan.loyalty_funding[group] || plan.loyalty_funding[brandSpecificKey])) {
                                hasSpecialInitiative = true;
                            }
                            if (!hasSpecialInitiative && plan.digital_funding && (plan.digital_funding[group] || plan.digital_funding[brandSpecificKey])) {
                                hasSpecialInitiative = true;
                            }
                            
                            if (brand === plan.winner && plan.promo_type && plan.tier1a?.includes(group)) {
                                const displayMult = supersaverData.displayMultipliers[plan.display_type] || 1.0;
                                const lift = supersaverData.promotionalLifts.tier1a[plan.promo_type];
                                const grossSales = groupData.retail * lift * displayMult * holidayMult;
                                
                                if (plan.promo_type === 'bogo') {
                                    groupNetSales = grossSales * 0.50;
                                } else if (plan.promo_type === 'b2g1') {
                                    groupNetSales = grossSales * 0.6667;
                                } else if (plan.promo_type === '25off') {
                                    groupNetSales = grossSales * 0.75;
                                }
                            } else if (brand === plan.winner && plan.promo_type && plan.tier1b?.includes(group)) {
                                const displayMult = supersaverData.displayMultipliers[plan.display_type] || 1.0;
                                const lift = supersaverData.promotionalLifts.tier1b[plan.promo_type];
                                const grossSales = groupData.retail * lift * displayMult * holidayMult;
                                
                                if (plan.promo_type === 'bogo') {
                                    groupNetSales = grossSales * 0.50;
                                } else if (plan.promo_type === 'b2g1') {
                                    groupNetSales = grossSales * 0.6667;
                                } else if (plan.promo_type === '25off') {
                                    groupNetSales = grossSales * 0.75;
                                }
                            } else if (brand === plan.tier2_allowed && plan.tier2_groups?.includes(group)) {
                                const baseLift = supersaverData.promotionalLifts.tier2[plan.tier2_response];
                                const tier2Discount = plan.tier2_response === 'high' ? 0.20 : 0.15;
                                
                                if (hasSpecialInitiative) {
                                    const baseGrossVolume = groupData.retail * baseLift * holidayMult;
                                    const incrementalGrossVolume = groupData.retail * (baseLift * 1.3 - baseLift) * holidayMult;
                                    const baseNetSales = baseGrossVolume * (1 - tier2Discount);
                                    const incrementalNetSales = incrementalGrossVolume * (1 - 0.20);
                                    groupNetSales = baseNetSales + incrementalNetSales;
                                } else {
                                    const grossSales = groupData.retail * baseLift * holidayMult;
                                    groupNetSales = grossSales * (1 - tier2Discount);
                                }
                            } else if (plan.tier3_investments && plan.tier3_investments[brand + '-' + group]) {
                                const investment = plan.tier3_investments[brand + '-' + group];
                                const baseLift = supersaverData.promotionalLifts.tier3[investment];
                                const tier3Discount = investment === 'high' ? 0.10 : 0.05;
                                
                                if (hasSpecialInitiative) {
                                    const baseGrossVolume = groupData.retail * baseLift * holidayMult;
                                    const incrementalGrossVolume = groupData.retail * (baseLift * 1.9 - baseLift) * holidayMult;
                                    const baseNetSales = baseGrossVolume * (1 - tier3Discount);
                                    const incrementalNetSales = incrementalGrossVolume * (1 - 0.20);
                                    groupNetSales = baseNetSales + incrementalNetSales;
                                } else {
                                    const grossSales = groupData.retail * baseLift * holidayMult;
                                    groupNetSales = grossSales * (1 - tier3Discount);
                                }
                            } else if (hasSpecialInitiative) {
                                const lift = 2.5;
                                const grossSales = groupData.retail * lift * holidayMult;
                                groupNetSales = grossSales * 0.80;
                            } else {
                                groupNetSales = groupData.retail * holidayMult;
                            }
                            
                            actualNetSales[brand] += groupNetSales;
                        });
                    }
                });
            }
            
            const totalActualNetSales = Object.values(actualNetSales).reduce((sum, val) => sum + val, 0);
            const currentMix = {};
            Object.keys(actualNetSales).forEach(brand => {
                currentMix[brand] = totalActualNetSales > 0 ? actualNetSales[brand] / totalActualNetSales : 0;
            });
            
            const currentWeightedMargin = 
                (currentMix['coca-cola'] * baseMargins['coca-cola']) + 
                (currentMix['pepsi'] * baseMargins['pepsi']) + 
                (currentMix['dps'] * baseMargins['dps']) + 
                (currentMix['pl'] * baseMargins['pl']);
            
            const promotionalSalesPercent = totalSales > 0 ? 
                (totalSales - totalBaselineSales) / totalSales : 0;
            
            const priorRetailerShare = 0.14;
            let currentRetailerShare;
            
            if (finalTotalRetailerCost + totalManufacturerFunding > 0) {
                currentRetailerShare = finalTotalRetailerCost / (finalTotalRetailerCost + totalManufacturerFunding);
            } else {
                currentRetailerShare = priorRetailerShare;
            }
            
            const retailerShareChange = currentRetailerShare - priorRetailerShare;
            const fundingImpact = retailerShareChange * promotionalSalesPercent;
            const currentMargin = (currentWeightedMargin - fundingImpact) * 100;
            
            document.getElementById('category-margin').textContent = `${currentMargin.toFixed(1)}%`;
            document.getElementById('obj-profit').textContent = `${currentMargin.toFixed(1)}%`;
        }

        function updateBrandWeekDisplay(elementId, counts, minT1, maxT1, targetT2 = null) {
            const element = document.getElementById(elementId);
            element.textContent = `T1: ${counts.tier1} | T2: ${counts.tier2}`;
            
            if (elementId === 'dps-weeks') {
                const statusEl = document.getElementById('dps-status');
                if (counts.tier1 >= minT1 && counts.tier1 <= maxT1 && counts.tier2 === targetT2) {
                    statusEl.className = 'week-status success';
                } else if (counts.tier2 < targetT2) {
                    statusEl.className = 'week-status warning';
                } else {
                    statusEl.className = 'week-status danger';
                }
            } else if (elementId === 'pl-weeks') {
                const statusEl = document.getElementById('pl-status');
                const totalWeeks = counts.tier1 + counts.tier2;
                if (totalWeeks >= 7 && totalWeeks <= 9) {
                    statusEl.className = 'week-status success';
                } else if (totalWeeks < 7) {
                    statusEl.className = 'week-status warning';
                } else {
                    statusEl.className = 'week-status danger';
                }
            }
        }

        window.onload = function() {
            if (sessionStorage.getItem('supersaver_authenticated') === 'true') {
                document.getElementById('passcode-overlay').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                initializeCalculator();
            }
        };
    </script>
</body>
</html>