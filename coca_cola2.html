<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coca-Cola - Beverage Negotiation Calculator</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .passcode-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .passcode-dialog {
            background: white;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
        }
        .passcode-dialog h2 {
            margin-top: 0;
            color: #DC143C;
        }
        .passcode-dialog input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            margin: 20px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        .passcode-dialog button {
            background: #DC143C;
            color: white;
            border: none;
            padding: 10px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
        }
        .passcode-dialog button:hover {
            background: #FF6347;
        }
        .passcode-error {
            color: #dc3545;
            margin-top: 10px;
        }
        .negotiation-selector-section {
            text-align: center;
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .negotiation-status {
            text-align: center;
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 13px;
        }
        .readonly-banner {
            text-align: center;
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-weight: bold;
            color: #856404;
        }
        .instructor-banner {
            text-align: center;
            background: #d4edda;
            border: 2px solid #28a745;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-weight: bold;
            color: #155724;
        }
        .checkpoint-controls {
            text-align: center;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .checkpoint-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }
        .checkpoint-btn:hover {
            background: #218838;
        }
        .checkpoint-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .header {
            text-align: center;
            background: linear-gradient(135deg, #d40000, #8b0000);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .auto-save-indicator {
            text-align: center;
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 8px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #0066cc;
        }
        .reset-section {
            text-align: center;
            margin-bottom: 20px;
        }
        .reset-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin: 0 5px;
        }
        .reset-btn:hover {
            background: #c82333;
        }
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .objectives {
            grid-column: span 2;
        }
        .week-planner {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .week-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .week-card {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            font-size: 12px;
        }
        .week-card.holiday {
            background: #fff3cd;
            border-color: #ffeaa7;
        }
        .week-card.promoted {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        .week-card.competitor {
            background: #d1ecf1;
            border-color: #bee5eb;
        }
        select, input {
            padding: 5px;
            margin: 2px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 12px;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .metric:last-child {
            border-bottom: none;
        }
        .metric-value {
            font-weight: bold;
            color: #2c3e50;
        }
        .budget-bar {
            background: #e0e0e0;
            height: 20px;
            border-radius: 10px;
            margin: 5px 0;
            overflow: hidden;
        }
        .budget-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.3s ease;
        }
        .budget-fill.warning {
            background: linear-gradient(90deg, #ff9800, #f57c00);
        }
        .budget-fill.danger {
            background: linear-gradient(90deg, #f44336, #d32f2f);
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .summary-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
        }
        .summary-card h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .summary-value {
            font-size: 18px;
            font-weight: bold;
            color: #d40000;
        }
        .promotion-details {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            font-size: 11px;
        }
        .group-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 5px 0;
        }
        .group-checkbox {
            display: flex;
            align-items: center;
            font-size: 11px;
            margin-right: 10px;
        }
        .group-checkbox input {
            margin-right: 3px;
        }
        .tier-section {
            margin: 8px 0;
            padding: 8px;
            background: #e8e8e8;
            border-radius: 3px;
        }
        .tier-title {
            font-weight: bold;
            font-size: 12px;
            color: #333;
            margin-bottom: 3px;
        }
        .tier-description {
            font-size: 10px;
            color: #666;
            margin-bottom: 5px;
        }
        .retailer-tabs {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            padding: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .retailer-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .retailer-tab.active {
            background: #d40000;
            color: white;
        }
        .export-btn, .import-btn {
            background: #d40000;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .export-btn:hover, .import-btn:hover {
            background: #8b0000;
        }
        .special-initiatives {
            margin-top: 10px;
            padding: 10px;
            background: #e7f3ff;
            border-radius: 5px;
            border: 1px solid #b3d9ff;
        }
        .initiative-title {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .initiative-option {
            margin: 3px 0;
            font-size: 11px;
        }
        .export-display {
            display: none;
            background: #f8f9fa;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .export-textarea {
            width: 100%;
            height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="passcode-overlay" class="passcode-overlay">
        <div class="passcode-dialog">
            <h2>ü•§ Coca-Cola Calculator</h2>
            <p>Enter passcode to access:</p>
            <input type="password" id="passcode-input" placeholder="Enter passcode" onkeypress="if(event.key==='Enter') checkPasscode()">
            <div id="passcode-error" class="passcode-error"></div>
            <button onclick="checkPasscode()">Access Calculator</button>
        </div>
    </div>

    <div id="main-content" style="display: none;">
        <div class="header">
            <h1>ü•§ Coca-Cola - Beverage Negotiation Calculator</h1>
            <p>Plan your promotional strategy across ValueMart and SuperSaver</p>
        </div>

        <div class="negotiation-selector-section">
            <label for="negotiation-select" style="font-weight: bold; margin-right: 10px;">Select Your Negotiation:</label>
            <select id="negotiation-select" onchange="changeNegotiation()" style="padding: 8px; font-size: 14px; border-radius: 5px;">
                <option value="">-- Select Negotiation --</option>
                <option value="negotiation-a">Negotiation A</option>
                <option value="negotiation-b">Negotiation B</option>
                <option value="negotiation-c">Negotiation C</option>
                <option value="negotiation-d">Negotiation D</option>
                <option value="negotiation-e">Negotiation E</option>
                <option value="negotiation-f">Negotiation F</option>
                <option value="negotiation-g">Negotiation G</option>
                <option value="negotiation-h">Negotiation H</option>
                <option value="negotiation-i">Negotiation I</option>
                <option value="negotiation-j">Negotiation J (Instructor Examples)</option>
            </select>
            <button id="instructor-unlock-btn" onclick="promptInstructorPasscode()" style="display: none; margin-left: 10px; padding: 8px 12px; background: #ffc107; border: none; border-radius: 5px; cursor: pointer;">üîì Instructor Mode</button>
        </div>

        <div id="negotiation-status" class="negotiation-status" style="display: none;">
            <strong>üìä Currently Viewing:</strong> <span id="current-negotiation"></span> - Coca-Cola Calculator
            <span style="margin-left: 20px;" id="last-updated"></span>
            <span style="margin-left: 20px; color: #28a745;" id="sync-indicator">‚óè Auto-sync enabled</span>
        </div>

        <div id="readonly-banner" class="readonly-banner" style="display: none;">
            üìö Viewing instructor examples - Read-only mode. Changes will not be saved.
        </div>

        <div id="instructor-banner" class="instructor-banner" style="display: none;">
            üîì Instructor Mode - Changes will be saved
        </div>

        <div id="checkpoint-controls" class="checkpoint-controls" style="display: none;">
            <input type="text" id="checkpoint-name" placeholder="Checkpoint name (e.g., Draft 1)" style="padding: 8px; width: 200px; border: 1px solid #ddd; border-radius: 5px;">
            <button class="checkpoint-btn" onclick="saveCheckpoint()">üíæ Save Checkpoint</button>
            <select id="checkpoint-select" onchange="promptRestoreCheckpoint()" style="margin-left: 10px; padding: 8px;">
                <option value="">-- Restore from Checkpoint --</option>
            </select>
        </div>

        <div class="auto-save-indicator">
            üíæ Your work is automatically saved to the cloud
        </div>

        <div class="reset-section">
            <button class="reset-btn" onclick="resetAllData()">Reset Calculator</button>
            <span style="font-size: 12px; color: #666; margin-left: 10px;">Clear all saved data for this negotiation</span>
        </div>

        <div class="retailer-tabs">
            <div class="retailer-tab active" onclick="switchRetailer('valuemart')">ValueMart</div>
            <div class="retailer-tab" onclick="switchRetailer('supersaver')">SuperSaver</div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h3>Budget Tracking</h3>
                <div class="metric">
                    <span>Trade Accrued</span>
                    <span class="metric-value" id="trade-accrued">$0</span>
                </div>
                <div class="budget-bar">
                    <div class="budget-fill" id="trade-bar" style="width: 0%"></div>
                </div>
                <div class="metric">
                    <span>Trade Spent</span>
                    <span class="metric-value" id="trade-spent">$0</span>
                </div>
                <div class="metric">
                    <span>Trade Balance</span>
                    <span class="metric-value" id="trade-balance">$0</span>
                </div>
                <hr style="margin: 15px 0;">
                <div class="metric">
                    <span>Marketing Funds Available</span>
                    <span class="metric-value">$3,000,000</span>
                </div>
                <div style="font-size: 10px; color: #666; margin-bottom: 10px;">
                    (Shared across both retailers)
                </div>
                <div class="metric">
                    <span>- Loyalty Program Support</span>
                    <span class="metric-value" id="loyalty-used">$0 / $1,200,000</span>
                </div>
                <div class="metric">
                    <span>- Digital/E-commerce Support</span>
                    <span class="metric-value" id="digital-used">$0 / $800,000</span>
                </div>
                <div class="metric">
                    <span>- Coke Zero Sugar Launch</span>
                    <span class="metric-value" id="coke-zero-used">$0 / $1,000,000</span>
                </div>
            </div>

            <div class="card">
                <h3>Performance Tracking</h3>
                <div class="metric">
                    <span>Total Wholesale Sales</span>
                    <span class="metric-value" id="total-sales">$0</span>
                </div>
                <div class="metric">
                    <span>Total Net Retail Sales</span>
                    <span class="metric-value" id="total-retail-sales">$0</span>
                </div>
                <div class="metric">
                    <span>Sales Growth vs. Prior Year</span>
                    <span class="metric-value" id="sales-growth">0%</span>
                </div>
                <div class="metric">
                    <span>Market Share (Current Retailer)</span>
                    <span class="metric-value" id="market-share">43%</span>
                </div>
                <div class="metric">
                    <span>Combined Market Share</span>
                    <span class="metric-value" id="combined-market-share">43.6%</span>
                </div>
                <div class="metric">
                    <span>Display Weeks Won</span>
                    <span class="metric-value" id="promo-weeks">0</span>
                </div>
                <div class="metric">
                    <span>Tier 2 Response Weeks</span>
                    <span class="metric-value" id="tier2-weeks">0</span>
                </div>
                <hr style="margin: 15px 0;">
                <div style="margin-top: 10px;">
                    <label style="font-size: 12px;">Competitor Net Sales (for market share calc):</label>
                    <input type="text" 
                           id="competitor-sales" 
                           value="100300000"
                           onchange="updateCompetitorSales()"
                           style="width: 100%; padding: 5px; margin-top: 5px;">
                    <div style="font-size: 10px; color: #666; margin-top: 3px;">
                        Estimate until actuals provided from retailer
                    </div>
                </div>
            </div>

            <div class="card objectives">
                <h3>Coca-Cola Objectives</h3>
                <div class="summary-grid">
                    <div class="summary-card">
                        <h4>Wholesale Sales Growth</h4>
                        <div class="summary-value" id="obj-growth">0%</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Target: +1% vs. Prior Year</div>
                    </div>
                    <div class="summary-card">
                        <h4>Market Share (Current)</h4>
                        <div class="summary-value" id="obj-share">43%</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Current retailer only</div>
                    </div>
                    <div class="summary-card">
                        <h4>Combined Market Share</h4>
                        <div class="summary-value" id="obj-combined-share">43.6%</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Target: Maintain 43.5%+</div>
                    </div>
                    <div class="summary-card">
                        <h4>Trade Efficiency</h4>
                        <div class="summary-value" id="obj-efficiency">0%</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Max: 101% of accrued</div>
                    </div>
                    <div class="summary-card">
                        <h4>Coke Zero Sugar Launch</h4>
                        <div class="summary-value" id="obj-launch">Not Secured</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Sept/Oct Support Needed</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="week-planner">
            <h3>26-Week Promotional Calendar - <span id="current-retailer">ValueMart</span></h3>
            <p>Plan your display wins and competitive responses</p>
            
            <button class="export-btn" onclick="showCurrentRetailerExport()">üìã Export for <span id="export-retailer-name">ValueMart</span></button>

            <!-- Export Modal -->
            <div id="exportDisplay" class="export-display">
                <h4 id="exportTitle">üìã Export Data</h4>
                <p id="exportDescription">Copy the data below and share with the retailer:</p>
                <textarea id="exportTextarea" class="export-textarea" readonly placeholder="Export data will appear here..."></textarea>
                <div style="margin-top: 10px;">
                    <button class="export-btn" onclick="selectAllExportData()">Select All</button>
                    <button class="export-btn" onclick="hideExportData()" style="background: #666;">Hide</button>
                </div>
            </div>
            
            <div class="week-grid" id="week-grid">
                <!-- Week cards will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        const CORRECT_PASSCODE = 'COKES4U';
        const INSTRUCTOR_PASSCODE = 'INSTRUCTOR2025';
        const firebaseConfig = {
            apiKey: "AIzaSyCkQR4KBiXI84O0Ev9DDtyhQfeZCbivDJg",
            authDomain: "bev-negotiation-calculators.firebaseapp.com",
            databaseURL: "https://bev-negotiation-calculators-default-rtdb.firebaseio.com",
            projectId: "bev-negotiation-calculators",
            storageBucket: "bev-negotiation-calculators.firebasestorage.app",
            messagingSenderId: "413961627132",
            appId: "1:413961627132:web:58fb6959a2bc3bd6f1be79"
        };

        let instructorMode = false;
        let currentNegotiationId = null;
        let isReadOnly = false;

        // Coca-Cola specific data
        const cocaColaData = {
            baselines: {
                valuemart: {
                    groups: {
                        'Group 1 - Coca-Cola': { wholesale: 304500, retail: 414120 },
                        'Group 2 - Diet Coke': { wholesale: 178500, retail: 242760 },
                        'Group 3 - Coke Zero Sugar': { wholesale: 136500, retail: 185640 },
                        'Group 4 - Sprite': { wholesale: 199500, retail: 271320 },
                        'Group 5 - Other Brands': { wholesale: 94500, retail: 128520 }
                    },
                    total: { wholesale: 913500, retail: 1242360 }
                },
                supersaver: {
                    groups: {
                        'Group 1 - Coca-Cola': { wholesale: 346500, retail: 477970 },
                        'Group 2 - Diet Coke': { wholesale: 220500, retail: 304290 },
                        'Group 3 - Coke Zero Sugar': { wholesale: 157500, retail: 217350 },
                        'Group 4 - Sprite': { wholesale: 231000, retail: 318780 },
                        'Group 5 - Other Brands': { wholesale: 115500, retail: 159390 }
                    },
                    total: { wholesale: 1071000, retail: 1477780 }
                }
            },
            holidayMultipliers: {
                'Week 1': 1.4,   // July 4th
                'Week 8': 1.1,   // Back-to-School
                'Week 10': 1.2,  // Labor Day
                'Week 18': 1.3,  // Halloween
                'Week 22': 1.6,  // Thanksgiving
                'Week 26': 1.5   // Christmas
            },
            promotionalLifts: {
                tier1a: { bogo: 5.5, b2g1: 4.0, '25off': 3.2 },
                tier1b: { bogo: 4.8, b2g1: 3.5, '25off': 2.8 },
                tier2: { high: 2.8, low: 2.3 },
                tier3: { high: 1.4, low: 1.2 }
            },
            displayMultipliers: {
                'lobby': 1.3,
                'aisle': 1.15,
                'endcap': 1.0
            },
            marketingFunds: {
                loyalty: 1200000,
                digital: 800000,
                coke_zero: 1000000
            }
        };

        let currentRetailer = 'valuemart';
        let weeklyPlans = {
            valuemart: {},
            supersaver: {}
        };
        let marketingUsed = {
            loyalty: 0,
            digital: 0,
            coke_zero: 0
        };
        let competitorSales = {
            valuemart: '100300000',
            supersaver: '97200000'
        };
        let competitorSalesManuallySet = {
            valuemart: false,
            supersaver: false
        };

        window.currentTimestamp = null;

        function checkPasscode() {
            const input = document.getElementById('passcode-input').value;
            const errorDiv = document.getElementById('passcode-error');
            
            if (input === CORRECT_PASSCODE) {
                sessionStorage.setItem('cocacola_authenticated', 'true');
                document.getElementById('passcode-overlay').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                initializeCalculator();
            } else {
                errorDiv.textContent = 'Incorrect passcode. Please try again.';
                document.getElementById('passcode-input').value = '';
            }
        }

        function initializeCalculator() {
            firebase.initializeApp(firebaseConfig);
            updateNegotiationStatus('Select your negotiation to begin', '');
        }

        function saveToFirebase() {
            if (isReadOnly) {
                return; // Silently fail in read-only mode
            }
            
            const negotiationId = document.getElementById('negotiation-select').value;
            if (!negotiationId) {
                return; // Silently fail if no negotiation selected
            }
            
            // Save ALL data for BOTH retailers
            // weeklyPlans is already structured as: { valuemart: {...}, supersaver: {...} }
            const dataToSave = {
                weeklyPlans: weeklyPlans,
                competitorSales: competitorSales,
                competitorSalesManuallySet: competitorSalesManuallySet,
                currentRetailer: currentRetailer,
                timestamp: new Date().toISOString()
            };
            
            firebase.database().ref(`semesters/active/${negotiationId}/cocacola`).set(dataToSave)
                .then(() => {
                    window.currentTimestamp = dataToSave.timestamp;
                    updateLastSaved();
                })
                .catch((error) => {
                    console.error('Save failed:', error);
                    alert('Failed to save: ' + error.message);
                });
        }

        function loadFromFirebase(negotiationId) {
            if (!negotiationId) return;
            
            currentNegotiationId = negotiationId;
            
            firebase.database().ref(`semesters/active/${negotiationId}/cocacola`).once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        // Load ALL data - weeklyPlans already has the nested structure
                        weeklyPlans = data.weeklyPlans || { valuemart: {}, supersaver: {} };
                        competitorSales = data.competitorSales || { valuemart: '100300000', supersaver: '97200000' };
                        competitorSalesManuallySet = data.competitorSalesManuallySet || { valuemart: false, supersaver: false };
                        currentRetailer = data.currentRetailer || 'valuemart';
                        
                        // Update UI to reflect loaded retailer tab
                        document.querySelectorAll('.retailer-tab').forEach(tab => tab.classList.remove('active'));
                        const activeTab = currentRetailer === 'valuemart' ? 0 : 1;
                        document.querySelectorAll('.retailer-tab')[activeTab].classList.add('active');
                        document.getElementById('current-retailer').textContent = currentRetailer === 'valuemart' ? 'ValueMart' : 'SuperSaver';
                        document.getElementById('export-retailer-name').textContent = currentRetailer === 'valuemart' ? 'ValueMart' : 'SuperSaver';
                        document.getElementById('competitor-sales').value = competitorSales[currentRetailer];
                        
                        // Re-render calculator
                        generateWeekGrid();
                        updateDashboard();
                        updateNegotiationStatus(negotiationId, data.timestamp);
                        
                        window.currentTimestamp = data.timestamp;
                        setupRealtimeListener(negotiationId);
                    } else {
                        // Initialize empty data for both tabs
                        weeklyPlans = { valuemart: {}, supersaver: {} };
                        competitorSales = { valuemart: '100300000', supersaver: '97200000' };
                        competitorSalesManuallySet = { valuemart: false, supersaver: false };
                        currentRetailer = 'valuemart';
                        
                        // Update UI
                        document.getElementById('current-retailer').textContent = 'ValueMart';
                        document.getElementById('export-retailer-name').textContent = 'ValueMart';
                        document.getElementById('competitor-sales').value = '100300000';
                        
                        generateWeekGrid();
                        updateDashboard();
                        updateNegotiationStatus(negotiationId, null);
                        setupRealtimeListener(negotiationId);
                    }
                    
                    // Handle Negotiation J
                    if (negotiationId === 'negotiation-j') {
                        document.getElementById('instructor-unlock-btn').style.display = 'inline-block';
                        if (sessionStorage.getItem('cocacola_instructor') === 'true') {
                            instructorMode = true;
                        }
                    } else {
                        document.getElementById('instructor-unlock-btn').style.display = 'none';
                        instructorMode = false;
                    }
                    
                    updateNegotiationJMode();
                    loadCheckpoints();
                })
                .catch((error) => {
                    console.error('Load failed:', error);
                    alert('Failed to load: ' + error.message);
                });
        }

        function setupRealtimeListener(negotiationId) {
            if (window.currentListener) {
                window.currentListener.off();
            }
            
            window.currentListener = firebase.database().ref(`semesters/active/${negotiationId}/cocacola`);
            window.currentListener.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.timestamp !== window.currentTimestamp) {
                    // Update ALL data - weeklyPlans has the nested structure
                    weeklyPlans = data.weeklyPlans || { valuemart: {}, supersaver: {} };
                    competitorSales = data.competitorSales || { valuemart: '100300000', supersaver: '97200000' };
                    competitorSalesManuallySet = data.competitorSalesManuallySet || { valuemart: false, supersaver: false };
                    
                    window.currentTimestamp = data.timestamp;
                    // Re-render calculator
                    generateWeekGrid();
                    updateDashboard();
                    updateLastSaved(data.timestamp);
                    
                    // FIX 4: Re-apply read-only status if student viewing Negotiation J during instructor changes
                    updateNegotiationJMode();
                }
            });
        }

        function changeNegotiation() {
            const negotiationId = document.getElementById('negotiation-select').value;
            if (negotiationId) {
                loadFromFirebase(negotiationId);
            } else {
                if (window.currentListener) {
                    window.currentListener.off();
                }
                weeklyPlans = { valuemart: {}, supersaver: {} };
                competitorSales = { valuemart: '100300000', supersaver: '97200000' };
                competitorSalesManuallySet = { valuemart: false, supersaver: false };
                generateWeekGrid();
                updateDashboard();
                document.getElementById('negotiation-status').style.display = 'none';
                document.getElementById('checkpoint-controls').style.display = 'none';
                document.getElementById('instructor-unlock-btn').style.display = 'none';
                document.getElementById('readonly-banner').style.display = 'none';
                document.getElementById('instructor-banner').style.display = 'none';
                currentNegotiationId = null;
            }
        }

        function updateNegotiationStatus(negotiationId, timestamp) {
            const statusDiv = document.getElementById('negotiation-status');
            const currentNegDiv = document.getElementById('current-negotiation');
            
            if (negotiationId && negotiationId !== 'Select your negotiation to begin') {
                statusDiv.style.display = 'block';
                let displayName = negotiationId.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                if (negotiationId === 'negotiation-j') {
                    displayName += ' (Instructor Examples)';
                }
                currentNegDiv.textContent = displayName;
                updateLastSaved(timestamp);
            } else {
                statusDiv.style.display = 'none';
            }
        }

        function updateLastSaved(timestamp) {
            const lastUpdatedDiv = document.getElementById('last-updated');
            if (timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                
                let timeText;
                if (diffMins < 1) {
                    timeText = 'Just now';
                } else if (diffMins === 1) {
                    timeText = '1 minute ago';
                } else if (diffMins < 60) {
                    timeText = `${diffMins} minutes ago`;
                } else {
                    timeText = date.toLocaleString();
                }
                
                lastUpdatedDiv.textContent = `Last updated: ${timeText} ‚úì`;
            } else {
                lastUpdatedDiv.textContent = 'No saved data yet';
            }
        }

        function resetAllData() {
            if (isReadOnly) {
                alert('Cannot reset in read-only mode');
                return;
            }
            
            const negotiationId = document.getElementById('negotiation-select').value;
            if (!negotiationId) {
                alert('Please select a negotiation first');
                return;
            }
            
            // FIX 5: Updated confirmation message
            if (confirm('Are you sure you want to reset all data for the current scenario in this negotiation? This will clear your current work and cannot be undone. This will NOT clear your saved promotional checkpoints, so if you want to come back to this scenario later, you should save it as a checkpoint first.')) {
                firebase.database().ref(`semesters/active/${negotiationId}/cocacola`).remove()
                    .then(() => {
                        // Reset all calculator data for both tabs
                        weeklyPlans = { valuemart: {}, supersaver: {} };
                        competitorSales = { valuemart: '100300000', supersaver: '97200000' };
                        competitorSalesManuallySet = { valuemart: false, supersaver: false };
                        currentRetailer = 'valuemart';
                        
                        // Update UI
                        document.querySelectorAll('.retailer-tab').forEach(tab => tab.classList.remove('active'));
                        document.querySelectorAll('.retailer-tab')[0].classList.add('active');
                        document.getElementById('current-retailer').textContent = 'ValueMart';
                        document.getElementById('export-retailer-name').textContent = 'ValueMart';
                        document.getElementById('competitor-sales').value = '100300000';
                        
                        generateWeekGrid();
                        updateDashboard();
                        
                        // FIX 3: Save empty data to Firebase to sync reset to other browsers immediately
                        const emptyData = {
                            weeklyPlans: { valuemart: {}, supersaver: {} },
                            competitorSales: { valuemart: '100300000', supersaver: '97200000' },
                            competitorSalesManuallySet: { valuemart: false, supersaver: false },
                            currentRetailer: 'valuemart',
                            timestamp: new Date().toISOString()
                        };
                        
                        return firebase.database().ref(`semesters/active/${negotiationId}/cocacola`).set(emptyData);
                    })
                    .then(() => {
                        alert('Data reset successfully');
                    })
                    .catch((error) => {
                        alert('Failed to reset: ' + error.message);
                    });
            }
        }

        function switchRetailer(retailer) {
            currentRetailer = retailer;
            document.querySelectorAll('.retailer-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            const retailerDisplayName = retailer === 'valuemart' ? 'ValueMart' : 'SuperSaver';
            document.getElementById('current-retailer').textContent = retailerDisplayName;
            document.getElementById('export-retailer-name').textContent = retailerDisplayName;
            
            const competitorSalesInput = document.getElementById('competitor-sales');
            competitorSalesInput.value = competitorSales[retailer];
            
            generateWeekGrid();
            updateDashboard();
            saveToFirebase();
        }

        function generateWeekGrid() {
            const weekGrid = document.getElementById('week-grid');
            weekGrid.innerHTML = '';
            
            const weeks = [
                'Week 1 (July 4th)', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 
                'Week 6', 'Week 7', 'Week 8 (Back-to-School)', 'Week 9', 
                'Week 10 (Labor Day)', 'Week 11', 'Week 12', 'Week 13', 'Week 14', 
                'Week 15', 'Week 16', 'Week 17', 'Week 18 (Halloween)', 'Week 19', 
                'Week 20', 'Week 21', 'Week 22 (Thanksgiving)', 'Week 23', 'Week 24', 
                'Week 25', 'Week 26 (Christmas)'
            ];

            weeks.forEach((week, index) => {
                const weekKey = `Week ${index + 1}`;
                const isHoliday = cocaColaData.holidayMultipliers[weekKey] > 1.0;
                const plan = weeklyPlans[currentRetailer][weekKey] || {};
                
                const weekCard = document.createElement('div');
                weekCard.className = `week-card ${isHoliday ? 'holiday' : ''} ${plan.status === 'won' ? 'promoted' : plan.status === 'competitor' ? 'competitor' : ''}`;
                
                weekCard.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">${week}</div>
                    <div style="font-size: 10px; color: #666;">
                        Holiday Mult: ${cocaColaData.holidayMultipliers[weekKey] || 1.0}x
                    </div>
                    <select onchange="updateWeekStatus('${weekKey}', this.value)" style="width: 100%; margin: 5px 0;">
                        <option value="">Status Unknown</option>
                        <option value="won" ${plan.status === 'won' ? 'selected' : ''}>Coca-Cola Wins Display</option>
                        <option value="competitor" ${plan.status === 'competitor' ? 'selected' : ''}>Competitor Wins</option>
                        <option value="no-display" ${plan.status === 'no-display' ? 'selected' : ''}>No Major Display</option>
                    </select>
                    <div id="week-${weekKey}-details" style="margin-top: 5px;">
                        ${generateWeekDetails(weekKey, plan)}
                    </div>
                `;
                weekGrid.appendChild(weekCard);
            });
        }

        function generateWeekDetails(weekKey, plan) {
            if (!plan.status) return '';

            let detailsHTML = '';

            if (plan.status === 'won') {
                detailsHTML = `
                    <div class="promotion-details">
                        <strong>Display Type:</strong>
                        <select onchange="updatePromoDetail('${weekKey}', 'display_type', this.value)" style="width: 100%;">
                            <option value="">Select Display</option>
                            <option value="endcap" ${plan.display_type === 'endcap' ? 'selected' : ''}>End Cap Only</option>
                            <option value="aisle" ${plan.display_type === 'aisle' ? 'selected' : ''}>End Cap + Aisle</option>
                            <option value="lobby" ${plan.display_type === 'lobby' ? 'selected' : ''}>End Cap + Lobby</option>
                        </select>
                        
                        <strong style="margin-top: 5px; display: block;">Promotion Type:</strong>
                        <select onchange="updatePromoDetail('${weekKey}', 'promo_type', this.value)" style="width: 100%;">
                            <option value="">Select Promo</option>
                            <option value="bogo" ${plan.promo_type === 'bogo' ? 'selected' : ''}>BOGO</option>
                            <option value="b2g1" ${plan.promo_type === 'b2g1' ? 'selected' : ''}>Buy 2 Get 1</option>
                            <option value="25off" ${plan.promo_type === '25off' ? 'selected' : ''}>25% Off</option>
                        </select>
                        
                        <div class="tier-section">
                            <div class="tier-title">Tier 1A - Display/Feature/TPR</div>
                            <div class="tier-description">Primary promotion (min 2, max 3 groups)</div>
                            <div class="group-selector">
                                ${generateGroupCheckboxes('tier1a', weekKey, plan.tier1a || [])}
                            </div>
                        </div>
                        
                        <div class="tier-section">
                            <div class="tier-title">Tier 1B - Feature/TPR</div>
                            <div class="tier-description">Supporting promotion (min 1 group)</div>
                            <div class="group-selector">
                                ${generateGroupCheckboxes('tier1b', weekKey, plan.tier1b || [])}
                            </div>
                        </div>
                    </div>
                `;
            } else if (plan.status === 'competitor') {
                detailsHTML = `
                    <div class="promotion-details">
                        <div class="tier-section">
                            <div class="tier-title">Tier 2 - Feature/TPR (Competitive Response)</div>
                            <select onchange="updatePromoDetail('${weekKey}', 'tier2_response', this.value)" style="width: 100%;">
                                <option value="">No Response</option>
                                <option value="high" ${plan.tier2_response === 'high' ? 'selected' : ''}>High Investment (20%)</option>
                                <option value="low" ${plan.tier2_response === 'low' ? 'selected' : ''}>Low Investment (15%)</option>
                            </select>
                            
                            ${plan.tier2_response ? `
                                <div style="margin-top: 5px;">
                                    <div class="tier-description">Select groups to promote:</div>
                                    <div class="group-selector">
                                        ${generateGroupCheckboxes('tier2', weekKey, plan.tier2_groups || [])}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            const promotedGroups = getPromotedGroups(weekKey, plan);
            const availableForTier3 = getAvailableGroupsForTier3(promotedGroups);
            
            if (availableForTier3.length > 0) {
                detailsHTML += `
                    <div class="tier-section">
                        <div class="tier-title">Tier 3 - TPR Only</div>
                        <div class="tier-description">Additional TPR for non-promoted groups</div>
                        <select onchange="updatePromoDetail('${weekKey}', 'tier3_level', this.value)" style="width: 100%; margin-bottom: 5px;">
                            <option value="">No Tier 3</option>
                            <option value="high" ${plan.tier3_level === 'high' ? 'selected' : ''}>High Investment (10%)</option>
                            <option value="low" ${plan.tier3_level === 'low' ? 'selected' : ''}>Low Investment (5%)</option>
                        </select>
                        ${plan.tier3_level ? `
                            <div class="group-selector">
                                ${generateGroupCheckboxes('tier3', weekKey, plan.tier3_groups || [], availableForTier3)}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            detailsHTML += generateSpecialInitiativesSection(weekKey, plan);

            return detailsHTML;
        }

        function generateSpecialInitiativesSection(weekKey, plan) {
            const weekNum = parseInt(weekKey.split(' ')[1]);
            let initiativeHTML = '<div class="special-initiatives"><div class="initiative-title">Special Initiatives</div>';
            
            const tier1Groups = (plan.tier1a || []).concat(plan.tier1b || []);
            const availableGroups = Object.keys(cocaColaData.baselines.valuemart.groups)
                .filter(group => !tier1Groups.includes(group));
            
            if (availableGroups.length === 0) {
                initiativeHTML += '<div style="font-size: 11px; color: #666;">No groups available (all on Tier 1 promotions)</div>';
                initiativeHTML += '</div>';
                return initiativeHTML;
            }
            
            if ((currentRetailer === 'valuemart' && weekNum >= 14 && weekNum <= 22) || 
                currentRetailer === 'supersaver') {
                initiativeHTML += `
                    <div class="initiative-option">
                        <label>
                            <input type="checkbox" ${plan.loyalty_initiative ? 'checked' : ''} 
                                   onchange="updateSpecialInitiative('${weekKey}', 'loyalty', this.checked)">
                            Loyalty Program ${currentRetailer === 'valuemart' ? 'Relaunch' : ''} Support
                        </label>
                        ${plan.loyalty_initiative ? `
                            <select onchange="updateInitiativeDetail('${weekKey}', 'loyalty_funding', this.value)" style="margin-left: 10px;">
                                <option value="retailer" ${plan.loyalty_funding === 'retailer' ? 'selected' : ''}>Retailer Funded (0%)</option>
                                <option value="half" ${plan.loyalty_funding === 'half' ? 'selected' : ''}>50/50 Split (10% each)</option>
                                <option value="full" ${plan.loyalty_funding === 'full' ? 'selected' : ''}>Mfr Full Fund (20%)</option>
                            </select>
                            <div style="margin-top: 5px;">
                                <div style="font-size: 10px; font-weight: bold;">Select Groups:</div>
                                <div class="group-selector">
                                    ${generateGroupCheckboxes('loyalty', weekKey, plan.loyalty_groups || [], availableGroups)}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            if (currentRetailer === 'valuemart' || 
                (currentRetailer === 'supersaver' && weekNum >= 14 && weekNum <= 22)) {
                initiativeHTML += `
                    <div class="initiative-option">
                        <label>
                            <input type="checkbox" ${plan.digital_initiative ? 'checked' : ''} 
                                   onchange="updateSpecialInitiative('${weekKey}', 'digital', this.checked)">
                            ${currentRetailer === 'supersaver' ? 'Digital Platform Launch' : 'E-commerce/Digital'} Support
                        </label>
                        ${plan.digital_initiative ? `
                            <select onchange="updateInitiativeDetail('${weekKey}', 'digital_funding', this.value)" style="margin-left: 10px;">
                                <option value="retailer" ${plan.digital_funding === 'retailer' ? 'selected' : ''}>Retailer Funded (0%)</option>
                                <option value="half" ${plan.digital_funding === 'half' ? 'selected' : ''}>50/50 Split (10% each)</option>
                                <option value="full" ${plan.digital_funding === 'full' ? 'selected' : ''}>Mfr Full Fund (20%)</option>
                            </select>
                            <div style="margin-top: 5px;">
                                <div style="font-size: 10px; font-weight: bold;">Select Groups:</div>
                                <div class="group-selector">
                                    ${generateGroupCheckboxes('digital', weekKey, plan.digital_groups || [], availableGroups)}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            const cokeZeroOnTier1 = (plan.tier1a?.includes('Group 3 - Coke Zero Sugar') || 
                                   plan.tier1b?.includes('Group 3 - Coke Zero Sugar'));
            
            if (weekNum >= 10 && weekNum <= 18 && cokeZeroOnTier1) {
                initiativeHTML += `
                    <div class="initiative-option">
                        <label>
                            <input type="checkbox" ${plan.coke_zero_launch ? 'checked' : ''} 
                                   onchange="updateSpecialInitiative('${weekKey}', 'coke_zero_launch', this.checked)">
                            Coke Zero Sugar New Taste Launch
                        </label>
                        <div style="font-size: 10px; color: #666; margin-left: 20px;">
                            Apply launch budget to Coke Zero Tier 1 promotion costs (shared across retailers)
                        </div>
                    </div>
                `;
            }
            
            initiativeHTML += '</div>';
            return initiativeHTML;
        }

        function getPromotedGroups(weekKey, plan) {
            let promoted = [];
            if (plan) {
                if (plan.tier1a) promoted = promoted.concat(plan.tier1a);
                if (plan.tier1b) promoted = promoted.concat(plan.tier1b);
                if (plan.tier2_groups) promoted = promoted.concat(plan.tier2_groups);
            }
            return promoted;
        }

        function getAvailableGroupsForTier3(promotedGroups) {
            const allGroups = Object.keys(cocaColaData.baselines.valuemart.groups);
            return allGroups.filter(group => !promotedGroups.includes(group));
        }

        function generateGroupCheckboxes(tier, weekKey, selectedGroups, availableGroups = null) {
            const groups = availableGroups || Object.keys(cocaColaData.baselines.valuemart.groups);
            return groups.map(group => `
                <div class="group-checkbox">
                    <input type="checkbox" 
                           id="${tier}-${weekKey}-${group}"
                           ${selectedGroups.includes(group) ? 'checked' : ''}
                           onchange="updateGroupSelection('${weekKey}', '${tier}', '${group}', this.checked)">
                    <label for="${tier}-${weekKey}-${group}">${group.split(' - ')[1]}</label>
                </div>
            `).join('');
        }

        function updateWeekStatus(week, status) {
            if (!weeklyPlans[currentRetailer][week]) {
                weeklyPlans[currentRetailer][week] = {};
            }
            weeklyPlans[currentRetailer][week].status = status;
            
            if (status !== 'won') {
                delete weeklyPlans[currentRetailer][week].display_type;
                delete weeklyPlans[currentRetailer][week].promo_type;
                delete weeklyPlans[currentRetailer][week].tier1a;
                delete weeklyPlans[currentRetailer][week].tier1b;
            }
            if (status !== 'competitor') {
                delete weeklyPlans[currentRetailer][week].tier2_response;
                delete weeklyPlans[currentRetailer][week].tier2_groups;
            }
            
            generateWeekGrid();
            updateDashboard();
            saveToFirebase();
        }

        function updatePromoDetail(week, field, value) {
            if (!weeklyPlans[currentRetailer][week]) {
                weeklyPlans[currentRetailer][week] = {};
            }
            weeklyPlans[currentRetailer][week][field] = value;
            
            if (field === 'tier3_level' && !value) {
                delete weeklyPlans[currentRetailer][week].tier3_groups;
            }
            
            const detailsDiv = document.getElementById(`week-${week}-details`);
            if (detailsDiv) {
                detailsDiv.innerHTML = generateWeekDetails(week, weeklyPlans[currentRetailer][week]);
            }
            
            updateDashboard();
            saveToFirebase();
        }

        function updateGroupSelection(week, tier, group, selected) {
            const plan = weeklyPlans[currentRetailer][week];
            if (!plan) return;

            if (tier === 'tier1a' && selected && plan.tier1b && plan.tier1b.includes(group)) {
                alert(`${group.split(' - ')[1]} is already in Tier 1B. A product group can only be in either Tier 1A or Tier 1B, not both.`);
                event.target.checked = false;
                return;
            }
            
            if (tier === 'tier1b' && selected && plan.tier1a && plan.tier1a.includes(group)) {
                alert(`${group.split(' - ')[1]} is already in Tier 1A. A product group can only be in either Tier 1A or Tier 1B, not both.`);
                event.target.checked = false;
                return;
            }

            let tierKey;
            if (tier === 'tier2') {
                tierKey = 'tier2_groups';
            } else if (tier === 'tier3') {
                tierKey = 'tier3_groups';
            } else if (tier === 'loyalty') {
                tierKey = 'loyalty_groups';
            } else if (tier === 'digital') {
                tierKey = 'digital_groups';
            } else {
                tierKey = tier;
            }
            
            if (!plan[tierKey]) plan[tierKey] = [];

            if (selected) {
                if (!plan[tierKey].includes(group)) {
                    plan[tierKey].push(group);
                }
            } else {
                plan[tierKey] = plan[tierKey].filter(g => g !== group);
            }

            if (tier === 'tier1a' || tier === 'tier1b') {
                if (!selected && group === 'Group 3 - Coke Zero Sugar' && plan.coke_zero_launch) {
                    plan.coke_zero_launch = false;
                }
                
                const detailsDiv = document.getElementById(`week-${week}-details`);
                if (detailsDiv) {
                    detailsDiv.innerHTML = generateWeekDetails(week, plan);
                }
            }

            updateDashboard();
            saveToFirebase();
        }

        function updateSpecialInitiative(week, initiative, enabled) {
            const plan = weeklyPlans[currentRetailer][week];
            if (!plan) return;

            if (initiative === 'loyalty') {
                plan.loyalty_initiative = enabled;
                if (enabled && !plan.loyalty_funding) {
                    plan.loyalty_funding = 'half';
                } else if (!enabled) {
                    delete plan.loyalty_funding;
                    delete plan.loyalty_groups;
                }
            } else if (initiative === 'digital') {
                plan.digital_initiative = enabled;
                if (enabled && !plan.digital_funding) {
                    plan.digital_funding = 'half';
                } else if (!enabled) {
                    delete plan.digital_funding;
                    delete plan.digital_groups;
                }
            } else if (initiative === 'coke_zero_launch') {
                plan.coke_zero_launch = enabled;
            }

            const detailsDiv = document.getElementById(`week-${week}-details`);
            if (detailsDiv) {
                detailsDiv.innerHTML = generateWeekDetails(week, plan);
            }
            
            updateDashboard();
            saveToFirebase();
        }

        function updateInitiativeDetail(week, field, value) {
            const plan = weeklyPlans[currentRetailer][week];
            if (!plan) return;
            
            plan[field] = value;
            updateDashboard();
            saveToFirebase();
        }

        function calculateWeeklyPerformance(week, retailer, plan) {
            const baseline = cocaColaData.baselines[retailer];
            const holidayMult = cocaColaData.holidayMultipliers[week] || 1.0;
            let totalSales = 0;
            let totalRetailSales = 0;
            let totalCost = 0;
            let totalWholesale = 0;

            const promotedGroups = {
                tier1: [],
                tier2: [],
                tier3: []
            };
            
            if (plan) {
                if (plan.status === 'won' && plan.display_type && plan.promo_type) {
                    if (plan.tier1a) promotedGroups.tier1.push(...plan.tier1a);
                    if (plan.tier1b) promotedGroups.tier1.push(...plan.tier1b);
                }
                
                if (plan.status === 'competitor' && plan.tier2_response && plan.tier2_groups) {
                    promotedGroups.tier2.push(...plan.tier2_groups);
                }
                
                if (plan.tier3_level && plan.tier3_groups) {
                    promotedGroups.tier3.push(...plan.tier3_groups);
                }
            }

            Object.keys(baseline.groups).forEach(group => {
                const groupData = baseline.groups[group];
                let groupWholesale = 0;
                let groupRetailSales = 0;
                let groupCost = 0;

                const hasLoyalty = plan?.loyalty_groups?.includes(group);
                const hasDigital = plan?.digital_groups?.includes(group);
                const hasSpecialInitiative = hasLoyalty || hasDigital;
                
                let specialInitiativeFunding = null;
                if (hasLoyalty && plan.loyalty_funding !== 'retailer') {
                    specialInitiativeFunding = plan.loyalty_funding === 'full' ? 0.20 : 0.10;
                } else if (hasDigital && plan.digital_funding !== 'retailer') {
                    specialInitiativeFunding = plan.digital_funding === 'full' ? 0.20 : 0.10;
                }

                if (promotedGroups.tier1.includes(group)) {
                    const displayMult = cocaColaData.displayMultipliers[plan.display_type] || 1.0;
                    const tier = plan.tier1a.includes(group) ? 'tier1a' : 'tier1b';
                    const lift = cocaColaData.promotionalLifts[tier][plan.promo_type];
                    
                    groupWholesale = groupData.wholesale * lift * displayMult * holidayMult;
                    
                    const grossRetail = groupData.retail * lift * displayMult * holidayMult;
                    let netRetail = grossRetail;
                    if (plan.promo_type === 'bogo') {
                        netRetail = grossRetail * 0.50;
                    } else if (plan.promo_type === 'b2g1') {
                        netRetail = grossRetail * 0.6667;
                    } else if (plan.promo_type === '25off') {
                        netRetail = grossRetail * 0.75;
                    }
                    groupRetailSales = netRetail;
                    
                    let costRate;
                    if (plan.promo_type === 'bogo') {
                        costRate = retailer === 'valuemart' ? 0.40 : 0.35;
                    } else if (plan.promo_type === 'b2g1') {
                        costRate = 0.2833;
                    } else {
                        costRate = 0.25;
                    }
                    groupCost = grossRetail * costRate;
                    
                } else if (promotedGroups.tier2.includes(group)) {
                    const baseLift = cocaColaData.promotionalLifts.tier2[plan.tier2_response];
                    let totalLift = baseLift;
                    
                    if (hasSpecialInitiative) {
                        totalLift = baseLift * 1.3;
                    }
                    
                    groupWholesale = groupData.wholesale * totalLift * holidayMult;
                    
                    const baseGrossRetail = groupData.retail * baseLift * holidayMult;
                    const totalGrossRetail = groupData.retail * totalLift * holidayMult;
                    
                    const tier2Discount = plan.tier2_response === 'high' ? 0.20 : 0.15;
                    
                    const tier2NetRetail = baseGrossRetail * (1 - tier2Discount);
                    
                    const incrementalGrossRetail = totalGrossRetail - baseGrossRetail;
                    const siNetRetail = incrementalGrossRetail * 0.80;
                    
                    groupRetailSales = tier2NetRetail + siNetRetail;
                    
                    groupCost = baseGrossRetail * tier2Discount;
                    
                    if (hasSpecialInitiative && specialInitiativeFunding) {
                        const incrementalRetail = totalGrossRetail - baseGrossRetail;
                        groupCost += incrementalRetail * specialInitiativeFunding;
                    }
                    
                } else if (promotedGroups.tier3.includes(group)) {
                    const baseLift = cocaColaData.promotionalLifts.tier3[plan.tier3_level];
                    let totalLift = baseLift;
                    
                    if (hasSpecialInitiative) {
                        totalLift = baseLift * 1.9;
                    }
                    
                    groupWholesale = groupData.wholesale * totalLift * holidayMult;
                    
                    const baseGrossRetail = groupData.retail * baseLift * holidayMult;
                    const totalGrossRetail = groupData.retail * totalLift * holidayMult;
                    
                    if (hasSpecialInitiative) {
                        const tier3Discount = plan.tier3_level === 'high' ? 0.10 : 0.05;
                        const tier3NetRetail = baseGrossRetail * (1 - tier3Discount);
                        
                        const incrementalGrossRetail = totalGrossRetail - baseGrossRetail;
                        const siNetRetail = incrementalGrossRetail * 0.80;
                        
                        groupRetailSales = tier3NetRetail + siNetRetail;
                    } else {
                        const tier3Discount = plan.tier3_level === 'high' ? 0.10 : 0.05;
                        groupRetailSales = baseGrossRetail * (1 - tier3Discount);
                    }
                    
                    const tier3Rate = plan.tier3_level === 'high' ? 0.10 : 0.05;
                    groupCost = baseGrossRetail * tier3Rate;
                    
                    if (hasSpecialInitiative && specialInitiativeFunding) {
                        const incrementalRetail = totalGrossRetail - baseGrossRetail;
                        groupCost += incrementalRetail * specialInitiativeFunding;
                    }
                    
                } else if (hasSpecialInitiative) {
                    const lift = 2.5;
                    groupWholesale = groupData.wholesale * lift * holidayMult;
                    
                    const grossRetail = groupData.retail * lift * holidayMult;
                    groupRetailSales = grossRetail * 0.80;
                    
                    if (specialInitiativeFunding) {
                        groupCost = grossRetail * specialInitiativeFunding;
                    }
                    
                } else {
                    groupWholesale = groupData.wholesale * holidayMult;
                    groupRetailSales = groupData.retail * holidayMult;
                }

                totalSales += groupWholesale;
                totalWholesale += groupWholesale;
                totalRetailSales += groupRetailSales;
                totalCost += groupCost;
            });

            const accrual = totalWholesale * 0.22;

            return { sales: totalSales, retailSales: totalRetailSales, cost: totalCost, accrual: accrual };
        }

        function updateDashboard() {
            let totalSales = 0;
            let totalRetailSales = 0;
            let totalCost = 0;
            let totalAccrual = 0;
            let displayWeeks = 0;
            let tier2Weeks = 0;
            
            for (let week = 1; week <= 26; week++) {
                const weekKey = `Week ${week}`;
                const plan = weeklyPlans[currentRetailer][weekKey];
                const perf = calculateWeeklyPerformance(weekKey, currentRetailer, plan);
                
                totalSales += perf.sales;
                totalRetailSales += perf.retailSales;
                totalCost += perf.cost;
                totalAccrual += perf.accrual;
                
                if (plan?.status === 'won') displayWeeks++;
                if (plan?.status === 'competitor' && plan?.tier2_response) tier2Weeks++;
            }

            marketingUsed = { loyalty: 0, digital: 0, coke_zero: 0 };
            let specialInitiativeTradeSpend = { 
                valuemart: { loyalty: 0, digital: 0, coke_zero: 0 }, 
                supersaver: { loyalty: 0, digital: 0, coke_zero: 0 }
            };
            
            ['valuemart', 'supersaver'].forEach(retailer => {
                for (let week = 1; week <= 26; week++) {
                    const weekKey = `Week ${week}`;
                    const plan = weeklyPlans[retailer][weekKey];
                    
                    if (plan) {
                        const baseline = cocaColaData.baselines[retailer];
                        const holidayMult = cocaColaData.holidayMultipliers[weekKey] || 1.0;
                        
                        Object.keys(baseline.groups).forEach(group => {
                            const groupData = baseline.groups[group];
                            
                            if (plan.loyalty_groups?.includes(group) && plan.loyalty_funding && plan.loyalty_funding !== 'retailer') {
                                const fundingRate = plan.loyalty_funding === 'full' ? 0.20 : 0.10;
                                let incrementalRetail = 0;
                                
                                if (plan.tier2_groups?.includes(group)) {
                                    const baseLift = cocaColaData.promotionalLifts.tier2[plan.tier2_response];
                                    const totalLift = baseLift * 1.3;
                                    incrementalRetail = groupData.retail * (totalLift - baseLift) * holidayMult;
                                } else if (plan.tier3_groups?.includes(group)) {
                                    const baseLift = cocaColaData.promotionalLifts.tier3[plan.tier3_level];
                                    const totalLift = baseLift * 1.9;
                                    incrementalRetail = groupData.retail * (totalLift - baseLift) * holidayMult;
                                } else {
                                    incrementalRetail = groupData.retail * 2.5 * holidayMult;
                                }
                                
                                const cost = incrementalRetail * fundingRate;
                                marketingUsed.loyalty += cost;
                                specialInitiativeTradeSpend[retailer].loyalty += cost;
                            }
                            
                            if (plan.digital_groups?.includes(group) && plan.digital_funding && plan.digital_funding !== 'retailer') {
                                const fundingRate = plan.digital_funding === 'full' ? 0.20 : 0.10;
                                let incrementalRetail = 0;
                                
                                if (plan.tier2_groups?.includes(group)) {
                                    const baseLift = cocaColaData.promotionalLifts.tier2[plan.tier2_response];
                                    const totalLift = baseLift * 1.3;
                                    incrementalRetail = groupData.retail * (totalLift - baseLift) * holidayMult;
                                } else if (plan.tier3_groups?.includes(group)) {
                                    const baseLift = cocaColaData.promotionalLifts.tier3[plan.tier3_level];
                                    const totalLift = baseLift * 1.9;
                                    incrementalRetail = groupData.retail * (totalLift - baseLift) * holidayMult;
                                } else {
                                    incrementalRetail = groupData.retail * 2.5 * holidayMult;
                                }
                                
                                const cost = incrementalRetail * fundingRate;
                                marketingUsed.digital += cost;
                                specialInitiativeTradeSpend[retailer].digital += cost;
                            }
                        });
                        
                        if (plan.coke_zero_launch && plan.status === 'won' && 
                            (plan.tier1a?.includes('Group 3 - Coke Zero Sugar') || 
                             plan.tier1b?.includes('Group 3 - Coke Zero Sugar'))) {
                            
                            const groupData = baseline.groups['Group 3 - Coke Zero Sugar'];
                            const displayMult = cocaColaData.displayMultipliers[plan.display_type] || 1.0;
                            const tier = plan.tier1a?.includes('Group 3 - Coke Zero Sugar') ? 'tier1a' : 'tier1b';
                            const lift = cocaColaData.promotionalLifts[tier][plan.promo_type];
                            const grossRetail = groupData.retail * lift * displayMult * holidayMult;
                            
                            let costRate;
                            if (plan.promo_type === 'bogo') {
                                costRate = retailer === 'valuemart' ? 0.40 : 0.35;
                            } else if (plan.promo_type === 'b2g1') {
                                costRate = 0.2833;
                            } else {
                                costRate = 0.25;
                            }
                            const cost = grossRetail * costRate;
                            
                            marketingUsed.coke_zero += cost;
                            specialInitiativeTradeSpend[retailer].coke_zero += cost;
                        }
                    }
                }
            });

            document.getElementById('trade-accrued').textContent = `${Math.round(totalAccrual).toLocaleString()}`;
            document.getElementById('trade-spent').textContent = `${Math.round(totalCost).toLocaleString()}`;
            
            let adjustedBalance = totalAccrual - totalCost;
            let marketingOffset = 0;
            
            const fundBuckets = [
                { name: 'loyalty', totalSpent: marketingUsed.loyalty, budget: cocaColaData.marketingFunds.loyalty },
                { name: 'digital', totalSpent: marketingUsed.digital, budget: cocaColaData.marketingFunds.digital },
                { name: 'coke_zero', totalSpent: marketingUsed.coke_zero, budget: cocaColaData.marketingFunds.coke_zero }
            ];
            
            fundBuckets.forEach(fund => {
                const currentRetailerSpent = specialInitiativeTradeSpend[currentRetailer][fund.name] || 0;
                
                if (currentRetailerSpent > 0) {
                    if (fund.totalSpent <= fund.budget) {
                        marketingOffset += currentRetailerSpent;
                    } else {
                        const overageAmount = fund.totalSpent - fund.budget;
                        const retailerShareOfOverage = currentRetailerSpent / fund.totalSpent;
                        const retailerOverageAllocation = overageAmount * retailerShareOfOverage;
                        marketingOffset += (currentRetailerSpent - retailerOverageAllocation);
                    }
                }
            });
            
            adjustedBalance += marketingOffset;
            
            const balanceText = marketingOffset > 0 ? 
                `${Math.round(totalAccrual - totalCost).toLocaleString()} (Adj: ${Math.round(adjustedBalance).toLocaleString()})` :
                `${Math.round(totalAccrual - totalCost).toLocaleString()}`;
            document.getElementById('trade-balance').textContent = balanceText;
            
            const loyaltyDisplay = Math.min(marketingUsed.loyalty, cocaColaData.marketingFunds.loyalty);
            const digitalDisplay = Math.min(marketingUsed.digital, cocaColaData.marketingFunds.digital);
            const cokeZeroDisplay = Math.min(marketingUsed.coke_zero, cocaColaData.marketingFunds.coke_zero);
            
            document.getElementById('loyalty-used').textContent = 
                `${Math.round(loyaltyDisplay).toLocaleString()} / ${cocaColaData.marketingFunds.loyalty.toLocaleString()}`;
            document.getElementById('digital-used').textContent = 
                `${Math.round(digitalDisplay).toLocaleString()} / ${cocaColaData.marketingFunds.digital.toLocaleString()}`;
            document.getElementById('coke-zero-used').textContent = 
                `${Math.round(cokeZeroDisplay).toLocaleString()} / ${cocaColaData.marketingFunds.coke_zero.toLocaleString()}`;
            
            const budgetBar = document.getElementById('trade-bar');
            const budgetPercent = totalAccrual > 0 ? Math.min(100, (totalCost / totalAccrual) * 100) : 0;
            budgetBar.style.width = `${budgetPercent}%`;
            budgetBar.className = budgetPercent > 101 ? 'budget-fill danger' : 
                                  budgetPercent > 95 ? 'budget-fill warning' : 'budget-fill';

            document.getElementById('total-sales').textContent = `${Math.round(totalSales).toLocaleString()}`;
            document.getElementById('total-retail-sales').textContent = `${Math.round(totalRetailSales).toLocaleString()}`;
            document.getElementById('promo-weeks').textContent = displayWeeks;
            document.getElementById('tier2-weeks').textContent = tier2Weeks;

            const priorYearSales = currentRetailer === 'valuemart' ? 62500000 : 73200000;
            const growthRate = totalSales > 0 ? ((totalSales - priorYearSales) / priorYearSales * 100) : 0;
            document.getElementById('sales-growth').textContent = `${growthRate.toFixed(1)}%`;
            document.getElementById('obj-growth').textContent = `${growthRate.toFixed(1)}%`;

            const marketingFundOffset = adjustedBalance - (totalAccrual - totalCost);
            const tradeEfficiencyDenominator = totalAccrual + marketingFundOffset;
            const efficiency = tradeEfficiencyDenominator > 0 ? (totalCost / tradeEfficiencyDenominator * 100) : 0;
            document.getElementById('obj-efficiency').textContent = `${efficiency.toFixed(1)}%`;

            let cokeZeroSpending = marketingUsed.coke_zero;
            let cokeZeroStatus;
            
            if (cokeZeroSpending === 0) {
                cokeZeroStatus = 'Not Secured';
            } else if (cokeZeroSpending >= cocaColaData.marketingFunds.coke_zero) {
                cokeZeroStatus = 'Fully Secured';
            } else {
                cokeZeroStatus = 'Partially Secured';
            }
            
            document.getElementById('obj-launch').textContent = cokeZeroStatus;

            updateMarketShare();
        }

        function showCurrentRetailerExport() {
            const retailerDisplayName = currentRetailer === 'valuemart' ? 'ValueMart' : 'SuperSaver';
            const exportData = generateExportData(retailerDisplayName);
            
            document.getElementById('exportTitle').textContent = `üìã Export Data for ${retailerDisplayName}`;
            document.getElementById('exportDescription').textContent = `Copy the data below and share with ${retailerDisplayName}:`;
            document.getElementById('exportTextarea').value = JSON.stringify(exportData, null, 2);
            document.getElementById('exportDisplay').style.display = 'block';
            saveToFirebase();
        }

        function generateExportData(retailerName) {
            const retailerPlans = weeklyPlans[currentRetailer] || {};
            
            const promotionalCommitments = [];
            let summaryStats = {
                totalTier1Weeks: 0,
                totalTier2Weeks: 0,
                promotionTypes: { bogo: 0, b2g1: 0, '25off': 0 },
                specialInitiatives: { loyalty: 0, digital: 0, coke_zero_launch: 0 },
                displayTypes: { lobby: 0, aisle: 0, endcap: 0 }
            };
            
            for (let week = 1; week <= 26; week++) {
                const weekKey = `Week ${week}`;
                const plan = retailerPlans[weekKey];
                
                if (plan && plan.status === 'won' && plan.display_type && plan.promo_type) {
                    const weekCommitment = {
                        week: weekKey,
                        status: 'display_winner',
                        displayType: plan.display_type,
                        promotionType: plan.promo_type,
                        tier1a: plan.tier1a || [],
                        tier1b: plan.tier1b || []
                    };
                    
                    const initiatives = {};
                    if (plan.loyalty_initiative && plan.loyalty_groups?.length > 0) {
                        initiatives.loyalty = {
                            funding: plan.loyalty_funding,
                            groups: plan.loyalty_groups
                        };
                        summaryStats.specialInitiatives.loyalty++;
                    }
                    if (plan.digital_initiative && plan.digital_groups?.length > 0) {
                        initiatives.digital = {
                            funding: plan.digital_funding,
                            groups: plan.digital_groups
                        };
                        summaryStats.specialInitiatives.digital++;
                    }
                    if (plan.coke_zero_launch) {
                        initiatives.coke_zero_launch = true;
                        summaryStats.specialInitiatives.coke_zero_launch++;
                    }
                    
                    if (Object.keys(initiatives).length > 0) {
                        weekCommitment.specialInitiatives = initiatives;
                    }
                    
                    promotionalCommitments.push(weekCommitment);
                    
                    summaryStats.totalTier1Weeks++;
                    summaryStats.promotionTypes[plan.promo_type]++;
                    summaryStats.displayTypes[plan.display_type]++;
                    
                } else if (plan && plan.status === 'competitor' && plan.tier2_response && plan.tier2_groups?.length > 0) {
                    const weekCommitment = {
                        week: weekKey,
                        status: 'competitive_response',
                        tier2Response: plan.tier2_response,
                        tier2Groups: plan.tier2_groups
                    };
                    
                    const initiatives = {};
                    if (plan.loyalty_initiative && plan.loyalty_groups?.length > 0) {
                        initiatives.loyalty = {
                            funding: plan.loyalty_funding,
                            groups: plan.loyalty_groups
                        };
                        summaryStats.specialInitiatives.loyalty++;
                    }
                    if (plan.digital_initiative && plan.digital_groups?.length > 0) {
                        initiatives.digital = {
                            funding: plan.digital_funding,
                            groups: plan.digital_groups
                        };
                        summaryStats.specialInitiatives.digital++;
                    }
                    
                    if (Object.keys(initiatives).length > 0) {
                        weekCommitment.specialInitiatives = initiatives;
                    }
                    
                    promotionalCommitments.push(weekCommitment);
                    summaryStats.totalTier2Weeks++;
                }
                
                if (plan && plan.tier3_level && plan.tier3_groups?.length > 0) {
                    let existingCommitment = promotionalCommitments.find(c => c.week === weekKey);
                    
                    if (!existingCommitment) {
                        existingCommitment = {
                            week: weekKey,
                            status: 'tier3_only'
                        };
                        promotionalCommitments.push(existingCommitment);
                    }
                    
                    existingCommitment.tier3 = {
                        level: plan.tier3_level,
                        groups: plan.tier3_groups
                    };
                }
                
                if (plan && !plan.status && (
                    (plan.loyalty_initiative && plan.loyalty_groups?.length > 0) ||
                    (plan.digital_initiative && plan.digital_groups?.length > 0)
                )) {
                    const initiatives = {};
                    if (plan.loyalty_initiative && plan.loyalty_groups?.length > 0) {
                        initiatives.loyalty = {
                            funding: plan.loyalty_funding,
                            groups: plan.loyalty_groups
                        };
                        summaryStats.specialInitiatives.loyalty++;
                    }
                    if (plan.digital_initiative && plan.digital_groups?.length > 0) {
                        initiatives.digital = {
                            funding: plan.digital_funding,
                            groups: plan.digital_groups
                        };
                        summaryStats.specialInitiatives.digital++;
                    }
                    
                    promotionalCommitments.push({
                        week: weekKey,
                        status: 'special_initiatives_only',
                        specialInitiatives: initiatives
                    });
                }
            }
            
            return {
                metadata: {
                    manufacturer: 'Coca-Cola',
                    retailer: retailerName,
                    exportDate: new Date().toISOString(),
                    note: 'Promotional commitments only - no internal financial or performance data included'
                },
                summary: {
                    totalCommitments: promotionalCommitments.length,
                    tier1DisplayWins: summaryStats.totalTier1Weeks,
                    tier2ResponseWeeks: summaryStats.totalTier2Weeks,
                    promotionTypes: summaryStats.promotionTypes,
                    displayTypes: summaryStats.displayTypes,
                    specialInitiatives: summaryStats.specialInitiatives
                },
                weeklyCommitments: promotionalCommitments,
                productGroups: {
                    'Group 1 - Coca-Cola': 'Flagship cola products',
                    'Group 2 - Diet Coke': 'Diet cola products', 
                    'Group 3 - Coke Zero Sugar': 'Zero sugar cola products',
                    'Group 4 - Sprite': 'Lemon-lime products',
                    'Group 5 - Other Brands': 'Additional Coca-Cola portfolio'
                },
                notes: [
                    'This export contains promotional commitments only',
                    'No internal financial or performance data is included',
                    'Special initiatives require separate partnership agreements',
                    'Coke Zero Sugar launch support available Sept/Oct (weeks 10-18)',
                    'All commitments subject to final contract terms'
                ]
            };
        }

        function hideExportData() {
            document.getElementById('exportDisplay').style.display = 'none';
        }

        function selectAllExportData() {
            const textarea = document.getElementById('exportTextarea');
            textarea.select();
            textarea.setSelectionRange(0, 99999);
        }

        function updateCompetitorSales() {
            competitorSales[currentRetailer] = document.getElementById('competitor-sales').value;
            competitorSalesManuallySet[currentRetailer] = true;
            updateMarketShare();
            saveToFirebase();
        }

        function updateMarketShare() {
            const cocaColaSalesCurrent = parseFloat(document.getElementById('total-retail-sales').textContent.replace(/[$,]/g, ''));
            const competitorSalesCurrent = parseFloat(competitorSales[currentRetailer]) || 0;
            
            const totalMarketCurrent = cocaColaSalesCurrent + competitorSalesCurrent;
            const marketShareCurrent = totalMarketCurrent > 0 ? (cocaColaSalesCurrent / totalMarketCurrent * 100) : 0;
            
            document.getElementById('market-share').textContent = `${marketShareCurrent.toFixed(1)}%`;
            document.getElementById('obj-share').textContent = `${marketShareCurrent.toFixed(1)}%`;
            
            let totalCocaColaSales = 0;
            let totalCompetitorSales = 0;
            
            ['valuemart', 'supersaver'].forEach(retailer => {
                let retailerCocaColaSales = 0;
                
                for (let week = 1; week <= 26; week++) {
                    const weekKey = `Week ${week}`;
                    const plan = weeklyPlans[retailer][weekKey];
                    const perf = calculateWeeklyPerformance(weekKey, retailer, plan);
                    retailerCocaColaSales += perf.retailSales;
                }
                
                totalCocaColaSales += retailerCocaColaSales;
                totalCompetitorSales += parseFloat(competitorSales[retailer]) || 0;
            });
            
            const totalCombinedMarket = totalCocaColaSales + totalCompetitorSales;
            const combinedMarketShare = totalCombinedMarket > 0 ? (totalCocaColaSales / totalCombinedMarket * 100) : 0;
            
            document.getElementById('combined-market-share').textContent = `${combinedMarketShare.toFixed(1)}%`;
            document.getElementById('obj-combined-share').textContent = `${combinedMarketShare.toFixed(1)}%`;
        }

        // Instructor Mode and Checkpoint Functions
        function promptInstructorPasscode() {
            const input = prompt('Enter instructor passcode:');
            if (input === INSTRUCTOR_PASSCODE) {
                instructorMode = true;
                sessionStorage.setItem('cocacola_instructor', 'true');
                updateNegotiationJMode();
            } else if (input !== null) {
                alert('Incorrect instructor passcode');
            }
        }

        function updateNegotiationJMode() {
            const instructorBanner = document.getElementById('instructor-banner');
            const readonlyBanner = document.getElementById('readonly-banner');
            const checkpointControls = document.getElementById('checkpoint-controls');
            
            if (currentNegotiationId === 'negotiation-j') {
                if (instructorMode) {
                    instructorBanner.style.display = 'block';
                    readonlyBanner.style.display = 'none';
                    isReadOnly = false;
                    checkpointControls.style.display = 'block';
                    loadCheckpoints();
                } else {
                    instructorBanner.style.display = 'none';
                    readonlyBanner.style.display = 'block';
                    isReadOnly = true;
                    checkpointControls.style.display = 'none';
                }
                disableSaveButtons(!instructorMode);
            } else {
                instructorBanner.style.display = 'none';
                readonlyBanner.style.display = 'none';
                isReadOnly = false;
                checkpointControls.style.display = 'block';
                disableSaveButtons(false);
                loadCheckpoints();
            }
        }

        function disableSaveButtons(disable) {
            // Disable all input elements except navigation controls
            const allInputs = document.querySelectorAll('button, input[type="text"], input[type="number"], input[type="checkbox"], select');
            allInputs.forEach(input => {
                // Don't disable navigation controls
                if (input.id !== 'negotiation-select' && 
                    input.id !== 'checkpoint-select' && 
                    input.id !== 'instructor-unlock-btn' &&
                    !input.closest('.retailer-tabs')) {
                    input.disabled = disable;
                    if (disable) {
                        input.style.opacity = '0.5';
                        input.style.cursor = 'not-allowed';
                    } else {
                        input.style.opacity = '1';
                        input.style.cursor = '';
                    }
                }
            });
        }

        function saveCheckpoint() {
            if (isReadOnly) {
                alert('Cannot save in read-only mode');
                return;
            }
            
            const negotiationId = document.getElementById('negotiation-select').value;
            if (!negotiationId) {
                alert('Please select a negotiation first');
                return;
            }
            
            const checkpointName = document.getElementById('checkpoint-name').value.trim();
            if (!checkpointName) {
                alert('Please enter a checkpoint name');
                return;
            }
            
            const maxCheckpoints = negotiationId === 'negotiation-j' ? 10 : 5;
            
            // Check existing checkpoints
            firebase.database().ref(`semesters/active/${negotiationId}`).once('value')
                .then((snapshot) => {
                    const data = snapshot.val() || {};
                    const checkpoints = Object.keys(data).filter(key => key.startsWith('cocacola-checkpoint-'));
                    
                    // Check if checkpoint name already exists
                    const existingCheckpoint = checkpoints.find(cp => {
                        const name = cp.replace('cocacola-checkpoint-', '');
                        return name === checkpointName;
                    });
                    
                    if (existingCheckpoint) {
                        if (confirm(`A checkpoint named "${checkpointName}" already exists. Replace it?`)) {
                            return saveCheckpointData(negotiationId, checkpointName);
                        }
                    } else if (checkpoints.length >= maxCheckpoints) {
                        // Need to replace one
                        const checkpointList = checkpoints.map(cp => cp.replace('cocacola-checkpoint-', '')).join('\n');
                        const toReplace = prompt(`You have ${maxCheckpoints} checkpoints (maximum). Enter the name of the checkpoint to replace:\n\n${checkpointList}`);
                        
                        if (toReplace) {
                            const checkpointKey = `cocacola-checkpoint-${toReplace}`;
                            if (checkpoints.includes(checkpointKey)) {
                                // Delete old checkpoint first
                                return firebase.database().ref(`semesters/active/${negotiationId}/${checkpointKey}`).remove()
                                    .then(() => saveCheckpointData(negotiationId, checkpointName));
                            } else {
                                alert('Checkpoint name not found');
                            }
                        }
                    } else {
                        // Room for new checkpoint
                        return saveCheckpointData(negotiationId, checkpointName);
                    }
                })
                .catch((error) => {
                    console.error('Error checking checkpoints:', error);
                    alert('Failed to save checkpoint: ' + error.message);
                });
        }

        function saveCheckpointData(negotiationId, checkpointName) {
            // Save ALL data for BOTH retailers in the checkpoint
            // weeklyPlans already has the structure: { valuemart: {...}, supersaver: {...} }
            const dataToSave = {
                weeklyPlans: weeklyPlans,
                competitorSales: competitorSales,
                competitorSalesManuallySet: competitorSalesManuallySet,
                currentRetailer: currentRetailer,
                timestamp: new Date().toISOString(),
                checkpointName: checkpointName
            };
            
            return firebase.database().ref(`semesters/active/${negotiationId}/cocacola-checkpoint-${checkpointName}`).set(dataToSave)
                .then(() => {
                    alert('Checkpoint saved: ' + checkpointName);
                    document.getElementById('checkpoint-name').value = '';
                    loadCheckpoints();
                })
                .catch((error) => {
                    console.error('Save failed:', error);
                    alert('Failed to save checkpoint: ' + error.message);
                });
        }

        function loadCheckpoints() {
            const negotiationId = document.getElementById('negotiation-select').value;
            if (!negotiationId) return;
            
            firebase.database().ref(`semesters/active/${negotiationId}`).once('value')
                .then((snapshot) => {
                    const data = snapshot.val() || {};
                    const checkpoints = Object.keys(data)
                        .filter(key => key.startsWith('cocacola-checkpoint-'))
                        .map(key => {
                            const name = key.replace('cocacola-checkpoint-', '');
                            const checkpoint = data[key];
                            return {
                                name: name,
                                timestamp: checkpoint.timestamp,
                                displayName: checkpoint.checkpointName || name
                            };
                        })
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    const select = document.getElementById('checkpoint-select');
                    select.innerHTML = '<option value="">-- Restore from Checkpoint --</option>';
                    
                    checkpoints.forEach(cp => {
                        const date = new Date(cp.timestamp);
                        const option = document.createElement('option');
                        option.value = cp.name;
                        option.textContent = `${cp.displayName} (${date.toLocaleString()})`;
                        select.appendChild(option);
                    });
                });
        }

        function promptRestoreCheckpoint() {
            const select = document.getElementById('checkpoint-select');
            const checkpointName = select.value;
            
            if (!checkpointName) return;
            
            if (confirm(`Restore checkpoint "${checkpointName}"? This will replace your current work with data from both ValueMart and SuperSaver tabs.`)) {
                restoreCheckpoint(checkpointName);
            }
            
            select.value = '';
        }

        function restoreCheckpoint(checkpointName) {
            const negotiationId = document.getElementById('negotiation-select').value;
            
            firebase.database().ref(`semesters/active/${negotiationId}/cocacola-checkpoint-${checkpointName}`).once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        // Restore ALL data - weeklyPlans has the nested structure
                        weeklyPlans = data.weeklyPlans || { valuemart: {}, supersaver: {} };
                        competitorSales = data.competitorSales || { valuemart: '100300000', supersaver: '97200000' };
                        competitorSalesManuallySet = data.competitorSalesManuallySet || { valuemart: false, supersaver: false };
                        currentRetailer = data.currentRetailer || 'valuemart';
                        
                        // Update UI to reflect restored tab
                        document.querySelectorAll('.retailer-tab').forEach(tab => tab.classList.remove('active'));
                        const activeTab = currentRetailer === 'valuemart' ? 0 : 1;
                        document.querySelectorAll('.retailer-tab')[activeTab].classList.add('active');
                        document.getElementById('current-retailer').textContent = currentRetailer === 'valuemart' ? 'ValueMart' : 'SuperSaver';
                        document.getElementById('export-retailer-name').textContent = currentRetailer === 'valuemart' ? 'ValueMart' : 'SuperSaver';
                        document.getElementById('competitor-sales').value = competitorSales[currentRetailer];
                        
                        // Re-render calculator
                        generateWeekGrid();
                        updateDashboard();
                        
                        // FIX 2: Sync restored checkpoint to Firebase so other browsers update immediately
                        saveToFirebase();
                        
                        alert('Checkpoint restored: ' + checkpointName);
                    }
                })
                .catch((error) => {
                    console.error('Restore failed:', error);
                    alert('Failed to restore checkpoint: ' + error.message);
                });
        }

        window.onload = function() {
            if (sessionStorage.getItem('cocacola_authenticated') === 'true') {
                document.getElementById('passcode-overlay').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                initializeCalculator();
            }
        };
    </script>
</body>
</html>